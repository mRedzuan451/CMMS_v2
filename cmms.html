<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ManCIS V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom Styles for Modals and Calendar */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            position: relative;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            border: 1px solid #e2e8f0;
            min-height: 120px;
        }
        .calendar-day-header {
            background-color: #f7fafc;
        }
        .today {
            background-color: #ebf8ff;
        }
        .other-month {
            background-color: #f7fafc;
            color: #a0aec0;
        }

        /* Styles for Printing Reports */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            @page {
                size: A4;
                margin: 20mm;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gray-200">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h1 class="text-2xl font-bold mb-6 text-center text-gray-700">ManCIS Login</h1>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-gray-700">Username</label>
                    <input type="text" id="username" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-300" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700">Password</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-300" required>
                </div>
                <p id="loginError" class="text-red-500 text-sm mb-4 text-center h-5"></p>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Log In</button>
            </form>
            <div class="mt-4 text-center">
                 <button id="createAccountBtn" class="text-blue-500 hover:underline">Create an Account</button>
            </div>
            <div class="mt-4 border-t pt-4">
                 <button id="bypassLoginBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Bypass Login (Admin)</button>
            </div>
        </div>
    </div>

    <div id="app" class="hidden">
        <aside id="sidebar" class="bg-gray-800 text-white w-64 min-h-screen fixed">
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-xl font-bold">ManCIS V3</h2>
            </div>
            <div id="userInfo" class="p-4 border-b border-gray-700">
                <p id="userFullName" class="font-semibold"></p>
                <p id="userRole" class="text-sm text-gray-400"></p>
                <p id="userDepartment" class="text-sm text-gray-400"></p>
            </div>
            <nav id="navMenu" class="p-4 space-y-2">
                </nav>
            <div class="absolute bottom-0 w-full p-4 border-t border-gray-700">
                <button id="logoutBtn" class="w-full flex items-center justify-center bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </button>
            </div>
        </aside>

        <main id="mainContent" class="ml-64 p-8">
            </main>
    </div>

    <div id="registrationModal" class="modal">
        <div class="modal-content">
             <h2 class="text-xl font-bold mb-4">Create New Account</h2>
             <form id="registrationForm">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="regFullName" placeholder="Full Name" class="col-span-2 px-3 py-2 border rounded" required>
                    <input type="text" id="regEmployeeId" placeholder="Employee ID" class="px-3 py-2 border rounded" required>
                    <input type="text" id="regUsername" placeholder="Username" class="px-3 py-2 border rounded" required>
                    <input type="password" id="regPassword" placeholder="Password" class="col-span-2 px-3 py-2 border rounded" required>
                    <select id="regDivision" class="col-span-2 px-3 py-2 border rounded" required></select>
                    <select id="regDepartment" class="col-span-2 px-3 py-2 border rounded" required></select>
                </div>
                 <p id="regError" class="text-red-500 text-sm mt-2 text-center h-5"></p>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded" data-close-modal>Cancel</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">Register</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="assetModal" class="modal">
        <div class="modal-content max-h-[90vh] overflow-y-auto">
             <h2 id="assetModalTitle" class="text-xl font-bold mb-4">Add Asset</h2>
             <form id="assetForm">
                <input type="hidden" id="assetId">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="assetName" placeholder="Asset Name" class="col-span-2 px-3 py-2 border rounded" required>
                    <input type="text" id="assetTag" placeholder="Asset Tag / Serial #" class="px-3 py-2 border rounded" required>
                    <input type="text" id="assetCategory" placeholder="Category (e.g., HVAC, Pump)" class="px-3 py-2 border rounded" required>
                    <input type="date" id="assetPurchaseDate" class="px-3 py-2 border rounded" required>
                    <div class="col-span-2 flex items-center gap-2">
                        <input type="text" id="assetCost" placeholder="Purchase Cost" class="flex-grow px-3 py-2 border rounded" required pattern="[0-9]+(\.[0-9]{1,2})?">
                        <select id="assetCurrency" class="px-3 py-2 border rounded">
                            <option value="MYR">MYR</option>
                            <option value="USD">USD</option>
                            <option value="JPY">JPY</option>
                            <option value="SGD">SGD</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label for="assetLocation" class="block text-sm font-medium text-gray-700">Location</label>
                        <select id="assetLocation" class="w-full mt-1 px-3 py-2 border rounded" required></select>
                    </div>
                    <div class="col-span-2">
                        <label for="assetRelatedParts" class="block text-sm font-medium text-gray-700">Related Spare Parts</label>
                        <select id="assetRelatedParts" class="w-full mt-1 px-3 py-2 border rounded" multiple></select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded" data-close-modal>Cancel</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">Save Asset</button>
                </div>
            </form>
        </div>
    </div>

    <div id="partModal" class="modal">
        <div class="modal-content max-h-[90vh] overflow-y-auto">
             <h2 id="partModalTitle" class="text-xl font-bold mb-4">Add Spare Part</h2>
             <form id="partForm">
                <input type="hidden" id="partId">
                <input type="hidden" id="originalPartQuantity">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label for="partCategory" class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="partCategory" class="w-full mt-1 px-3 py-2 border rounded" required>
                            <option value="Mechanical">Mechanical</option>
                            <option value="Electrical">Electrical</option>
                            <option value="Hydraulic">Hydraulic</option>
                            <option value="Pneumatic">Pneumatic</option>
                            <option value="Consumable">Consumable</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label for="partName" class="block text-sm font-medium text-gray-700">Part Name</label>
                        <input type="text" id="partName" list="partNameList" placeholder="Select or type new part name" class="w-full mt-1 px-3 py-2 border rounded" required>
                        <datalist id="partNameList"></datalist>
                    </div>
                    <div class="col-span-2">
                         <label for="partMaker" class="block text-sm font-medium text-gray-700">Maker</label>
                        <input type="text" id="partMaker" list="partMakerList" placeholder="Select or type new maker" class="w-full mt-1 px-3 py-2 border rounded">
                        <datalist id="partMakerList"></datalist>
                    </div>
                    <input type="text" id="partSku" placeholder="Part Number / SKU" class="px-3 py-2 border rounded" required>
                    <input type="number" id="partQuantity" placeholder="Quantity" class="px-3 py-2 border rounded" required min="0">
                     <input type="number" id="partMinQuantity" placeholder="Low Stock Threshold" class="px-3 py-2 border rounded" required min="0">
                    <input type="text" id="partSupplier" placeholder="Supplier" class="px-3 py-2 border rounded">
                    <div class="flex items-center gap-2">
                         <input type="number" id="partPrice" placeholder="Price" class="flex-grow px-3 py-2 border rounded" step="0.01" min="0">
                         <select id="partCurrency" class="px-3 py-2 border rounded">
                            <option value="MYR">MYR</option>
                            <option value="USD">USD</option>
                            <option value="JPY">JPY</option>
                            <option value="SGD">SGD</option>
                        </select>
                    </div>
                     <input type="text" id="partLeadTime" placeholder="Lead Time (e.g., 7 days)" class="px-3 py-2 border rounded">
                    <div class="col-span-2">
                        <label for="partLocation" class="block text-sm font-medium text-gray-700">Storage Location</label>
                        <select id="partLocation" class="w-full mt-1 px-3 py-2 border rounded" required></select>
                    </div>
                    <div class="col-span-2">
                        <label for="partRelatedAssets" class="block text-sm font-medium text-gray-700">Related Assets</label>
                        <select id="partRelatedAssets" class="w-full mt-1 px-3 py-2 border rounded" multiple></select>
                    </div>
                    <div class="col-span-2">
                        <label for="partAttachmentRef" class="block text-sm font-medium text-gray-700">Attachment Reference (URL/Path)</label>
                        <input type="text" id="partAttachmentRef" placeholder="e.g., https://example.com/spec.pdf" class="w-full mt-1 px-3 py-2 border rounded">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded" data-close-modal>Cancel</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">Save Part</button>
                </div>
            </form>
        </div>
    </div>

    <div id="workOrderModal" class="modal">
        <div class="modal-content max-h-[90vh] overflow-y-auto">
             <h2 id="workOrderModalTitle" class="text-xl font-bold mb-4">Create Work Order</h2>
             <form id="workOrderForm">
                <input type="hidden" id="workOrderId">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label for="woTitle" class="block text-sm font-medium text-gray-700">Title</label>
                        <input type="text" id="woTitle" class="w-full mt-1 px-3 py-2 border rounded" required>
                    </div>
                    <div class="col-span-2">
                        <label for="woDescription" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="woDescription" rows="3" class="w-full mt-1 px-3 py-2 border rounded" required></textarea>
                    </div>
                    <div>
                        <label for="woAsset" class="block text-sm font-medium text-gray-700">Associated Asset</label>
                        <select id="woAsset" class="w-full mt-1 px-3 py-2 border rounded" required></select>
                    </div>
                    <div>
                        <label for="woAssignedTo" class="block text-sm font-medium text-gray-700">Assigned To</label>
                        <select id="woAssignedTo" class="w-full mt-1 px-3 py-2 border rounded" required></select>
                    </div>
                    <div>
                        <label for="woTask" class="block text-sm font-medium text-gray-700">Task</label>
                        <select id="woTask" class="w-full mt-1 px-3 py-2 border rounded" required>
                            <option value="Cleaning">Cleaning</option>
                            <option value="Lubrication">Lubrication</option>
                            <option value="Inspection">Inspection</option>
                            <option value="Adjustment">Adjustment</option>
                            <option value="Replacement">Replacement</option>
                            <option value="Overhaul">Overhaul</option>
                            <option value="Assemble">Assemble</option>
                            <option value="Removal">Removal</option>
                        </select>
                    </div>
                    <div>
                        <label for="woDueDate" class="block text-sm font-medium text-gray-700">Due Date</label>
                        <input type="date" id="woDueDate" class="w-full mt-1 px-3 py-2 border rounded" required>
                    </div>
                    <div class="col-span-2">
                        <label for="woBreakdownTime" class="block text-sm font-medium text-gray-700">Breakdown Time (if applicable)</label>
                        <input type="datetime-local" id="woBreakdownTime" class="w-full mt-1 px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label for="woPriority" class="block text-sm font-medium text-gray-700">Priority</label>
                        <select id="woPriority" class="w-full mt-1 px-3 py-2 border rounded" required>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    <div>
                        <label for="woFrequency" class="block text-sm font-medium text-gray-700">Frequency (PM)</label>
                        <select id="woFrequency" class="w-full mt-1 px-3 py-2 border rounded" required>
                            <option value="One-Time">One-Time</option>
                            <option value="Daily">Daily</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Monthly">Monthly</option>
                            <option value="Yearly">Yearly</option>
                        </select>
                    </div>
                     <div class="col-span-2">
                        <label for="woStatus" class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="woStatus" class="w-full mt-1 px-3 py-2 border rounded" required>
                            <option value="Open">Open</option>
                            <option value="In Progress">In Progress</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Delay">Delay</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                     <div class="col-span-2 mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Checklist</label>
                        <div id="woChecklistContainer" class="space-y-2 mb-2">
                            </div>
                        <div class="flex gap-2">
                            <input type="text" id="newChecklistItem" class="flex-grow px-3 py-2 border rounded" placeholder="Add a new checklist step...">
                            <button type="button" id="addChecklistItemBtn" class="bg-green-500 text-white px-3 py-2 rounded">+</button>
                        </div>
                    </div>
                </div>
                <div id="woPartsSection" class="mt-4 col-span-2 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Required Spare Parts</label>
                    <div id="woPartsContainer" class="space-y-2">
                        </div>
                    <button type="button" id="addWoPartBtn" class="mt-2 text-sm text-blue-500 hover:underline">+ Add Part</button>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded" data-close-modal>Cancel</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">Save Work Order</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="partRequestModal" class="modal">
        <div class="modal-content max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">New Part Request</h2>
            <form id="partRequestForm">
                <div class="mb-4 flex items-center">
                    <input type="checkbox" id="requestNewPartCheckbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="requestNewPartCheckbox" class="ml-2 block text-sm text-gray-900">Request a new part (not in the list)</label>
                </div>

                <div id="existingPartContainer" class="mb-4">
                    <label for="requestPartId" class="block text-sm font-medium text-gray-700">Part</label>
                    <select id="requestPartId" class="w-full mt-1 px-3 py-2 border rounded"></select>
                </div>

                <div id="newPartContainer" class="hidden space-y-4 mb-4">
                    <div>
                        <label for="newPartName" class="block text-sm font-medium text-gray-700">New Part Name</label>
                        <input type="text" id="newPartName" class="w-full mt-1 px-3 py-2 border rounded" placeholder="e.g., 1/2 inch bolt">
                    </div>
                     <div>
                        <label for="newPartNumber" class="block text-sm font-medium text-gray-700">Part Number / SKU</label>
                        <input type="text" id="newPartNumber" class="w-full mt-1 px-3 py-2 border rounded" placeholder="e.g., BLT-12-SS">
                    </div>
                     <div>
                        <label for="newPartMaker" class="block text-sm font-medium text-gray-700">Maker (optional)</label>
                        <input type="text" id="newPartMaker" class="w-full mt-1 px-3 py-2 border rounded" placeholder="e.g., Acme Corp">
                    </div>
                </div>

                <div class="mb-4">
                    <label for="requestQuantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                    <input type="number" id="requestQuantity" class="w-full mt-1 px-3 py-2 border rounded" min="1" required>
                </div>

                <div class="mb-4">
                    <label for="requestPurpose" class="block text-sm font-medium text-gray-700">Purpose</label>
                    <textarea id="requestPurpose" rows="2" class="w-full mt-1 px-3 py-2 border rounded" placeholder="e.g., For urgent repair of Asset-X" required></textarea>
                </div>

                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded" data-close-modal>Cancel</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">Submit Request</button>
                </div>
            </form>
        </div>
    </div>

    <div id="storageRequestModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Request Part from Storage</h2>
            <form id="storageRequestForm">
                <div class="mb-4">
                    <label for="storageRequestPartId" class="block text-sm font-medium text-gray-700">Part</label>
                    <select id="storageRequestPartId" class="w-full mt-1 px-3 py-2 border rounded" required></select>
                </div>
                <div class="mb-4">
                    <label for="storageRequestQuantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                    <input type="number" id="storageRequestQuantity" class="w-full mt-1 px-3 py-2 border rounded" min="1" required>
                </div>
                 <div class="mb-4">
                    <label for="storageRequestPurpose" class="block text-sm font-medium text-gray-700">Purpose</label>
                    <textarea id="storageRequestPurpose" rows="2" class="w-full mt-1 px-3 py-2 border rounded" placeholder="e.g., For urgent repair of Asset-X" required></textarea>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded" data-close-modal>Cancel</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">Submit Request</button>
                </div>
            </form>
        </div>
    </div>

    <div id="receivePartsModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Receive Parts</h2>
            <form id="receivePartsForm">
                <div class="mb-4">
                    <label for="receiveRequestId" class="block text-sm font-medium text-gray-700">Approved Request</label>
                    <select id="receiveRequestId" class="w-full mt-1 px-3 py-2 border rounded" required></select>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded" data-close-modal>Cancel</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">Receive</button>
                </div>
            </form>
        </div>
    </div>

    <div id="restockPartsModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Restock Parts</h2>
            <form id="restockPartsForm">
                 <div class="mb-4">
                    <label for="restockPartId" class="block text-sm font-medium text-gray-700">Received Part</label>
                    <select id="restockPartId" class="w-full mt-1 px-3 py-2 border rounded" required></select>
                </div>
                <div class="mb-4">
                    <label for="restockLocationId" class="block text-sm font-medium text-gray-700">Storage Location</label>
                    <select id="restockLocationId" class="w-full mt-1 px-3 py-2 border rounded" required></select>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded" data-close-modal>Cancel</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">Restock</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="workOrderDetailModal" class="modal">
        <div class="modal-content max-h-[90vh] overflow-y-auto">
            <div id="workOrderDetailContent"></div>
            <div class="mt-6 flex justify-end">
                <button type="button" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded" data-close-modal>Close</button>
            </div>
        </div>
    </div>

    <div id="completeWorkOrderModal" class="modal">
        <div class="modal-content max-h-[90vh] overflow-y-auto">
             <h2 class="text-xl font-bold mb-4">Complete Work Order</h2>
             <form id="completeWorkOrderForm">
                <input type="hidden" id="completeWorkOrderId">
                <p class="mb-2"><strong>Work Order:</strong> <span id="completeWoTitle"></span></p>
                <p class="mb-4">Please confirm all checklist items are completed:</p>
                <div id="completeWoChecklist" class="space-y-2 border p-4 rounded-md bg-gray-50 mb-4">
                    </div>
                <div class="mb-4">
                    <label for="completionNotes" class="block text-sm font-medium text-gray-700">Completion Notes (optional)</label>
                    <textarea id="completionNotes" rows="3" class="w-full mt-1 px-3 py-2 border rounded"></textarea>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded" data-close-modal>Cancel</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded">Mark as Complete</button>
                </div>
            </form>
        </div>
    </div>

    <div id="assetDetailModal" class="modal">
        <div class="modal-content max-h-[90vh] overflow-y-auto">
            <div id="assetDetailContent"></div>
            <div class="mt-6 flex justify-end">
                <button type="button" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded" data-close-modal>Close</button>
            </div>
        </div>
    </div>
    
    <div id="partDetailModal" class="modal">
        <div class="modal-content max-h-[90vh] overflow-y-auto">
            <div id="partDetailContent"></div>
            <div class="mt-6 flex justify-end">
                <button type="button" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded" data-close-modal>Close</button>
            </div>
        </div>
    </div>

    <div id="calendarDetailModal" class="modal">
        <div class="modal-content max-h-[90vh] overflow-y-auto">
            <h2 id="calendarDetailModalTitle" class="text-xl font-bold mb-4">Work Orders</h2>
            <div id="calendarDetailContent" class="space-y-4">
                </div>
            <div class="mt-6 flex justify-end">
                <button type="button" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded" data-close-modal>Close</button>
            </div>
        </div>
    </div>

    <div id="transferAssetModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Transfer Asset</h2>
            <form id="transferAssetForm">
                <input type="hidden" id="transferAssetId">
                <p class="mb-4">Transferring: <strong id="transferAssetName"></strong></p>
                <div class="mb-4">
                    <label for="transferLocation" class="block text-sm font-medium text-gray-700">New Location</label>
                    <select id="transferLocation" class="w-full mt-1 px-3 py-2 border rounded" required></select>
                </div>
                 <div class="mb-4">
                    <label for="transferNotes" class="block text-sm font-medium text-gray-700">Notes</label>
                    <textarea id="transferNotes" rows="2" class="w-full mt-1 px-3 py-2 border rounded"></textarea>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded" data-close-modal>Cancel</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">Confirm Transfer</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="print-area" class="hidden"></div>


<script>
(function() {
    'use strict';
    
    // =================================================================================
    //  PARTITION 1: CONFIGURATION & STATE
    // =================================================================================
    
    const state = {
        currentUser: null,
        currentPage: 'dashboard',
        sortKey: 'id',
        sortOrder: 'asc',
        calendarDate: new Date(),
    };

    const db = {
        get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
        set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
        init: () => {
            if (!localStorage.getItem('cmms_initialized')) {
                console.log('Initializing CMMS database with seed data...');
                const divisions = [
                    { id: 1, name: 'DA-RY1' }, 
                    { id: 2, name: 'DA-RY2' },
                    { id: 3, name: 'IND-RY' },
                    { id: 4, name: 'PMF' }
                ];
                const departments = [
                    { id: 1, divisionId: 1, name: 'G2RL' },
                    { id: 2, divisionId: 2, name: 'G6D' },
                    { id: 3, divisionId: 2, name: 'G6RN' },
                    { id: 4, divisionId: 2, name: 'G5LE' },
                    { id: 5, divisionId: 2, name: 'G5NB' },
                    { id: 6, divisionId: 3, name: 'G2RS' },
                    { id: 7, divisionId: 3, name: 'G2RV' }
                ];
                const productionLines = [
                    { id: 1, departmentId: 1, name: 'G2RL #1' },
                    { id: 2, departmentId: 1, name: 'G2RL #2' },
                    { id: 3, departmentId: 2, name: 'Welding Area' },
                    { id: 4, departmentId: 3, name: 'Receiving Dock' }
                ];
                const cabinets = [
                    { id: 1, departmentId: 3, name: 'WH-CAB-01' },
                    { id: 2, departmentId: 1, name: 'AS-CAB-01' }
                ];
                const shelves = [
                    { id: 1, cabinetId: 1, name: 'Shelf A' },
                    { id: 2, cabinetId: 1, name: 'Shelf B' },
                    { id: 3, cabinetId: 2, name: 'Shelf 1' }
                ];
                const boxes = [
                    { id: 1, shelfId: 1, name: 'Box 1-A' },
                    { id: 2, shelfId: 1, name: 'Box 1-B' },
                    { id: 3, shelfId: 2, name: 'Box 2-A' }
                ];
                db.set('locations', { divisions, departments, productionLines, cabinets, shelves, boxes });
                
                const users = [
                    { id: 1, fullName: 'Admin User', employeeId: 'A001', username: 'admin', password: 'admin123', role: 'Admin', divisionId: 1, departmentId: 1 },
                    { id: 2, fullName: 'John Engineer', employeeId: 'E001', username: 'jengineer', password: 'password', role: 'Engineer', divisionId: 1, departmentId: 1 },
                    { id: 3, fullName: 'Jane Clerk', employeeId: 'C001', username: 'jclerk', password: 'password', role: 'Clerk', divisionId: 1, departmentId: 2 },
                    { id: 4, fullName: 'Mike Manager', employeeId: 'M001', username: 'mmanager', password: 'password', role: 'Manager', divisionId: 2, departmentId: 3 },
                    { id: 5, fullName: 'Susan Supervisor', employeeId: 'S001', username: 'ssupervisor', password: 'password', role: 'Supervisor', divisionId: 1, departmentId: 1 },
                    { id: 6, fullName: 'Tom Technician', employeeId: 'T001', username: 'ttechnician', password: 'password', role: 'Technician', divisionId: 1, departmentId: 2 },
                ];
                db.set('users', users);

                const assets = [
                    { id: 1, name: 'CNC Machine', tag: 'CNC-001', category: 'Machining', locationId: 'pl-1', status: 'Active', purchaseDate: '2022-01-15', cost: 150000, currency: 'MYR', workOrderHistory: [], transferHistory: [] },
                    { id: 2, name: 'Conveyor Belt', tag: 'CV-001', category: 'Material Handling', locationId: 'pl-2', status: 'Active', purchaseDate: '2021-05-20', cost: 25000, currency: 'MYR', workOrderHistory: [], transferHistory: [] },
                    { id: 3, name: 'Welding Robot', tag: 'WR-001', category: 'Robotics', locationId: 'pl-3', status: 'Active', purchaseDate: '2023-02-10', cost: 85000, currency: 'MYR', workOrderHistory: [], transferHistory: [] },
                    { id: 4, name: 'Forklift', tag: 'FL-001', category: 'Vehicle', locationId: 'pl-4', status: 'Under Maintenance', purchaseDate: '2020-11-01', cost: 30000, currency: 'MYR', workOrderHistory: [], transferHistory: [] }
                ];
                db.set('assets', assets);

                const parts = [
                    { id: 1, name: '75A Fuse', sku: 'F-75A', quantity: 50, minQuantity: 10, locationId: 'box-1', category: 'Electrical', maker: 'Siemens', supplier: 'ElecSupplies Inc.', price: 5.99, currency: 'MYR', leadTime: '3 days', attachmentRef: '', relatedAssetIds: [1], transactionHistory: [] },
                    { id: 2, name: 'Hydraulic Oil 5L', sku: 'OIL-H5', quantity: 8, minQuantity: 5, locationId: 'box-2', category: 'Hydraulic', maker: 'Mobil', supplier: 'Global Oils', price: 75.50, currency: 'MYR', leadTime: '1 day', attachmentRef: '', relatedAssetIds: [4], transactionHistory: [] },
                    { id: 3, name: 'Conveyor Roller', sku: 'CV-RL-01', quantity: 20, minQuantity: 10, locationId: 'box-3', category: 'Mechanical', maker: 'SKF', supplier: 'Bearings Direct', price: 120.00, currency: 'MYR', leadTime: '10 days', attachmentRef: '', relatedAssetIds: [2], transactionHistory: [] },
                    { id: 4, name: 'Welding Tip #5', sku: 'WT-05', quantity: 150, minQuantity: 50, locationId: 'box-3', category: 'Consumable', maker: 'Lincoln Electric', supplier: 'Welders Friend', price: 2.25, currency: 'MYR', leadTime: '2 days', attachmentRef: '', relatedAssetIds: [3], transactionHistory: [] },
                ];
                db.set('parts', parts);
                
                const workOrders = [
                    { id: 1, title: 'Quarterly CNC Lubrication', description: 'Lubricate all moving parts as per manual.', assetId: 1, assignedTo: 2, task: 'Lubrication', dueDate: getNextDate(0), priority: 'Medium', frequency: 'Monthly', status: 'Open', breakdownTimestamp: null, requiredParts: [{partId: 1, quantity: 2}] },
                    { id: 2, title: 'Forklift Engine Check', description: 'Inspect engine for leaks and wear.', assetId: 4, assignedTo: 6, task: 'Inspection', dueDate: getNextDate(5), priority: 'High', frequency: 'One-Time', status: 'Open', breakdownTimestamp: null, requiredParts: [] },
                    { id: 3, title: 'Daily Conveyor Belt Cleaning', description: 'Clean debris from belt and rollers.', assetId: 2, assignedTo: 5, task: 'Cleaning', dueDate: getNextDate(-2), priority: 'Low', frequency: 'Daily', status: 'Completed', completedDate: getNextDate(-2), breakdownTimestamp: null, requiredParts: [] },
                ];
                db.set('workOrders', workOrders);

                db.set('logs', [{ id: 1, user: 'System', action: 'System Initialized', details: 'Default data loaded.', timestamp: new Date().toISOString() }]);
                
                db.set('partRequests', []);
                db.set('receivedParts', []);

                localStorage.setItem('cmms_initialized', 'true');
            }
        }
    };
    
    // =================================================================================
    //  PARTITION 2: PERMISSIONS & AUTHENTICATION
    // =================================================================================

    const can = {
        view: (item) => {
            if (state.currentUser.role === 'Admin') return true;
            
            const { departments = [], productionLines = [], cabinets = [], shelves = [], boxes = [] } = db.get('locations') || {};
            let itemDepartmentId;

            if (item.departmentId) {
                itemDepartmentId = item.departmentId;
            } else if (item.locationId) {
                if (typeof item.locationId !== 'string' || !item.locationId.includes('-')) return false;
                const [type, id] = item.locationId.split('-');
                const numId = parseInt(id);
                if (type === 'pl') {
                    const pLine = productionLines.find(l => l.id === numId);
                    if(pLine) itemDepartmentId = pLine.departmentId;
                } else if (type === 'box') {
                    const box = boxes.find(b => b.id === numId);
                    const shelf = box ? shelves.find(s => s.id === box.shelfId) : null;
                    const cabinet = shelf ? cabinets.find(c => c.id === shelf.cabinetId) : null;
                    if(cabinet) itemDepartmentId = cabinet.departmentId;
                } else if (type === 'sh') {
                    const shelf = shelves.find(s => s.id === numId);
                    const cabinet = shelf ? cabinets.find(c => c.id === shelf.cabinetId) : null;
                    if(cabinet) itemDepartmentId = cabinet.departmentId;
                } else if (type === 'cab') {
                    const cabinet = cabinets.find(c => c.id === numId);
                    if(cabinet) itemDepartmentId = cabinet.departmentId;
                }
            } else if (item.assetId) {
                const asset = db.get('assets').find(a => a.id === item.assetId);
                if(asset && asset.locationId && typeof asset.locationId === 'string' && asset.locationId.includes('-')) {
                    const [type, id] = asset.locationId.split('-');
                    const numId = parseInt(id);
                    if (type === 'pl') {
                       const pLine = productionLines.find(l => l.id === numId);
                       if(pLine) itemDepartmentId = pLine.departmentId;
                    }
                }
            }
            return itemDepartmentId === state.currentUser.departmentId;
        },
        viewPage: (page) => {
            const adminOnlyPages = ['userManagement', 'activityLog'];
            if (adminOnlyPages.includes(page)) {
                return state.currentUser.role === 'Admin';
            }
            const nonClerkPages = ['assets', 'parts', 'workOrders', 'workOrderCalendar'];
            if (state.currentUser.role === 'Clerk' && nonClerkPages.includes(page)) {
                return false;
            }
            return true;
        }
    };
    
    // =================================================================================
    //  PARTITION 3: UTILITY & HELPER FUNCTIONS
    // =================================================================================
    
    function getNextId(key) {
        const data = db.get(key);
        return data.length > 0 ? Math.max(...data.map(d => d.id)) + 1 : 1;
    }

    function logActivity(action, details = '') {
        const logs = db.get('logs');
        const newLog = {
            id: getNextId('logs'),
            user: state.currentUser ? state.currentUser.fullName : 'System',
            action,
            details,
            timestamp: new Date().toISOString(),
        };
        logs.unshift(newLog);
        db.set('logs', logs);
    }
    
    function getNextDate(days) {
        const date = new Date();
        date.setDate(date.getDate() + days);
        return date.toISOString().split('T')[0];
    }
    
    function getFullLocationName(locationId) {
        if (typeof locationId !== 'string' || !locationId.includes('-')) return 'N/A';
        
        const { divisions = [], departments = [], productionLines = [], cabinets = [], shelves = [], boxes = [] } = db.get('locations') || {};
        
        const [type, id] = locationId.split('-');
        const numId = parseInt(id);

        if (type === 'pl') {
            const pLine = productionLines.find(l => l.id === numId);
            if (!pLine) return 'N/A';
            const dept = departments.find(d => d.id === pLine.departmentId);
            const div = dept ? divisions.find(d => d.id === dept.divisionId) : null;
            return `${div ? div.name + ' > ' : ''}${dept ? dept.name + ' > ' : ''}${pLine.name}`;
        } else if (type === 'box') {
            const box = boxes.find(b => b.id === numId);
            if (!box) return 'N/A';
            const shelf = shelves.find(s => s.id === box.shelfId);
            if (!shelf) return box.name;
            const cabinet = cabinets.find(c => c.id === shelf.cabinetId);
            if (!cabinet) return `${shelf.name} > ${box.name}`;
            const dept = departments.find(d => d.id === cabinet.departmentId);
            const div = dept ? divisions.find(d => d.id === dept.divisionId) : null;
            return `${div ? div.name + ' > ' : ''}${dept ? dept.name + ' > ' : ''}${cabinet.name} > ${shelf.name} > ${box.name}`;
        } else if (type === 'sh') {
            const shelf = shelves.find(s => s.id === numId);
            if (!shelf) return 'N/A';
            const cabinet = cabinets.find(c => c.id === shelf.cabinetId);
            if (!cabinet) return shelf.name;
            const dept = departments.find(d => d.id === cabinet.departmentId);
            const div = dept ? divisions.find(d => d.id === dept.divisionId) : null;
            return `${div ? div.name + ' > ' : ''}${dept ? dept.name + ' > ' : ''}${cabinet.name} > ${shelf.name}`;
        } else if (type === 'cab') {
            const cabinet = cabinets.find(c => c.id === numId);
            if (!cabinet) return 'N/A';
            const dept = departments.find(d => d.id === cabinet.departmentId);
            const div = dept ? divisions.find(d => d.id === dept.divisionId) : null;
            return `${div ? div.name + ' > ' : ''}${dept ? dept.name + ' > ' : ''}${cabinet.name}`;
        }
        return 'N/A';
    }

    function getUserDepartment(user) {
        const { departments = [] } = db.get('locations') || {};
        const dept = departments.find(d => d.id === user.departmentId);
        return dept ? dept.name : 'N/A';
    }

    function getNextIdForLocation(locationKey) {
        const locations = db.get('locations');
        const data = locations[locationKey] || [];
        return data.length > 0 ? Math.max(...data.map(d => d.id)) + 1 : 1;
    }

    function showTemporaryMessage(message, isError = false) {
        const messageBox = document.createElement('div');
        messageBox.textContent = message;
        messageBox.style.position = 'fixed';
        messageBox.style.bottom = '20px';
        messageBox.style.left = '50%';
        messageBox.style.transform = 'translateX(-50%)';
        messageBox.style.padding = '10px 20px';
        messageBox.style.borderRadius = '8px';
        messageBox.style.color = 'white';
        messageBox.style.backgroundColor = isError ? 'rgba(239, 68, 68, 0.9)' : 'rgba(34, 197, 94, 0.9)';
        messageBox.style.zIndex = '2000';
        messageBox.style.transition = 'opacity 0.5s';
        
        document.body.appendChild(messageBox);
        
        setTimeout(() => {
            messageBox.style.opacity = '0';
            setTimeout(() => {
                if(document.body.contains(messageBox)) {
                    document.body.removeChild(messageBox);
                }
            }, 500);
        }, 3000);
    }
    
    // =================================================================================
    //  PARTITION 4: UI RENDERING & MODALS
    // =================================================================================
    
    function renderDashboard() {
        const assets = db.get('assets').filter(can.view);
        const workOrders = db.get('workOrders').filter(can.view);
        const parts = db.get('parts').filter(can.view);
        const partRequests = db.get('partRequests').filter(can.view);
        
        const openWOs = workOrders.filter(wo => wo.status === 'Open').length;
        const pendingRequests = partRequests.filter(pr => pr.status === 'Requested').length;
        
        const thisMonth = new Date().getMonth();
        const thisYear = new Date().getFullYear();
        const completedThisMonth = workOrders.filter(wo => {
            if (wo.status !== 'Completed') return false;
            const completedDate = new Date(wo.completedDate);
            return completedDate.getMonth() === thisMonth && completedDate.getFullYear() === thisYear;
        }).length;

        const lowStockItems = parts.filter(p => p.quantity <= p.minQuantity).length;
        
        const highPriorityWOs = workOrders.filter(wo => wo.priority === 'High' && wo.status === 'Open');

        return `
            <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500">Total Assets</h3>
                    <p class="text-3xl font-bold">${assets.length}</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500">Open Work Orders</h3>
                    <p class="text-3xl font-bold">${openWOs}</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500">Pending Part Requests</h3>
                    <p class="text-3xl font-bold">${pendingRequests}</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500">Low Stock Items</h3>
                    <p class="text-3xl font-bold">${lowStockItems}</p>
                </div>
            </div>
            <h2 class="text-2xl font-bold mb-4">High Priority Work Orders</h2>
            <div class="bg-white p-4 rounded-lg shadow">
                ${highPriorityWOs.length > 0 ? `
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left p-2">Title</th>
                                <th class="text-left p-2">Asset</th>
                                <th class="text-left p-2">Due Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${highPriorityWOs.map(wo => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-2">${wo.title}</td>
                                    <td class="p-2">${db.get('assets').find(a=>a.id === wo.assetId)?.name || 'N/A'}</td>
                                    <td class="p-2">${wo.dueDate}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : `<p class="text-gray-500">No high priority work orders.</p>`}
            </div>
        `;
    }

    function renderAssetsPage() {
        const assets = db.get('assets').filter(can.view);
        return `
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Asset Management</h1>
                <div>
                    <button id="importAssetsBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded mr-2">
                        <i class="fas fa-file-csv mr-2"></i>Import from CSV
                    </button>
                    <input type="file" id="csvAssetInput" class="hidden" accept=".csv">
                    <button id="printAssetsBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">
                        <i class="fas fa-print mr-2"></i>Print List
                    </button>
                    <button id="addAssetBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        <i class="fas fa-plus mr-2"></i>Add Asset
                    </button>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <input type="text" id="assetSearch" class="w-full mb-4 px-3 py-2 border rounded" placeholder="Search by name, tag, or category...">
                <div class="overflow-x-auto">
                    <table class="w-full" id="assetTable">
                        <thead><tr class="border-b">
                            <th class="p-2 text-left cursor-pointer" data-sort="name">Name <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" data-sort="tag">Tag <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" data-sort="locationId">Location <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" data-sort="status">Status <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left">Actions</th>
                        </tr></thead>
                        <tbody id="assetTableBody">
                            ${generateTableRows('assets', assets)}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    function renderPartsPage() {
        const parts = db.get('parts').filter(can.view);
        return `
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Spare Parts Management</h1>
                <div>
                    <button id="importPartsBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded mr-2">
                        <i class="fas fa-file-csv mr-2"></i>Import from CSV
                    </button>
                    <input type="file" id="csvFileInput" class="hidden" accept=".csv">
                    <button id="printPartsBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">
                        <i class="fas fa-print mr-2"></i>Print List
                    </button>
                    <button id="addPartBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        <i class="fas fa-plus mr-2"></i>Add Part
                    </button>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <input type="text" id="partSearch" class="w-full mb-4 px-3 py-2 border rounded" placeholder="Search by name, SKU, category, or maker...">
                <div class="overflow-x-auto">
                    <table class="w-full" id="partTable">
                        <thead><tr class="border-b">
                            <th class="p-2 text-left cursor-pointer" data-sort="name">Part Name <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" data-sort="sku">SKU <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" data-sort="category">Category <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" data-sort="supplier">Supplier <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" data-sort="quantity">Quantity <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" data-sort="price">Price <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left">Actions</th>
                        </tr></thead>
                        <tbody id="partTableBody">
                            ${generateTableRows('parts', parts)}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    function renderPartsRequestPage() {
        const partRequests = db.get('partRequests').filter(can.view);
        return `
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Part Requests</h1>
                <div class="space-x-2">
                     <button id="printPurchaseListBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded">
                        <i class="fas fa-file-invoice mr-2"></i>Print Purchase List
                    </button>
                     <button id="requestFromStorageBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded">
                        <i class="fas fa-warehouse mr-2"></i>Request from Storage
                    </button>
                    <button id="newPartRequestBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        <i class="fas fa-plus mr-2"></i>New Purchase Request
                    </button>
                    <button id="receivePartsBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">
                        <i class="fas fa-box-open mr-2"></i>Receive Parts
                    </button>
                    <button id="restockPartsBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">
                        <i class="fas fa-dolly-flatbed mr-2"></i>Restock Parts
                    </button>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead><tr class="border-b">
                            <th class="p-2 text-left">Part Name</th>
                            <th class="p-2 text-left">Part Number</th>
                            <th class="p-2 text-left">Maker</th>
                            <th class="p-2 text-left">Quantity</th>
                            <th class="p-2 text-left">Purpose</th>
                            <th class="p-2 text-left">Status</th>
                            <th class="p-2 text-left">Actions</th>
                        </tr></thead>
                        <tbody>
                            ${generateTableRows('partRequests', partRequests)}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    function renderWorkOrdersPage() {
        const workOrders = db.get('workOrders').filter(can.view);
        return `
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Work Order Management</h1>
                <div>
                    <button id="printWorkOrdersBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">
                        <i class="fas fa-print mr-2"></i>Print List
                    </button>
                    <button id="addUrgentWorkOrderBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded mr-2">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Urgent Request
                    </button>
                    <button id="addWorkOrderBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        <i class="fas fa-plus mr-2"></i>Create Work Order
                    </button>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <input type="text" id="workOrderSearch" class="w-full mb-4 px-3 py-2 border rounded" placeholder="Search by title or asset name...">
                <div class="overflow-x-auto">
                    <table class="w-full" id="workOrderTable">
                        <thead><tr class="border-b">
                            <th class="p-2 text-left cursor-pointer" data-sort="title">Title <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" data-sort="assetId">Asset <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" data-sort="dueDate">Due Date <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" data-sort="priority">Priority <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left cursor-pointer" data-sort="status">Status <i class="fas fa-sort"></i></th>
                            <th class="p-2 text-left">Actions</th>
                        </tr></thead>
                        <tbody id="workOrderTableBody">
                            ${generateTableRows('workOrders', workOrders)}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    function renderWorkOrderCalendar() {
        const { calendarDate } = state;
        const month = calendarDate.getMonth();
        const year = calendarDate.getFullYear();

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const workOrders = db.get('workOrders').filter(can.view);

        let calendarHtml = `
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Work Order Calendar</h1>
                <div class="flex items-center space-x-2">
                    <button id="prevMonthBtn" class="px-3 py-1 bg-gray-200 rounded">&lt;</button>
                    <h2 class="text-xl font-semibold">${calendarDate.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
                    <button id="nextMonthBtn" class="px-3 py-1 bg-gray-200 rounded">&gt;</button>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="calendar-grid">
                    <div class="text-center font-bold p-2 calendar-day-header">Sun</div>
                    <div class="text-center font-bold p-2 calendar-day-header">Mon</div>
                    <div class="text-center font-bold p-2 calendar-day-header">Tue</div>
                    <div class="text-center font-bold p-2 calendar-day-header">Wed</div>
                    <div class="text-center font-bold p-2 calendar-day-header">Thu</div>
                    <div class="text-center font-bold p-2 calendar-day-header">Fri</div>
                    <div class="text-center font-bold p-2 calendar-day-header">Sat</div>
        `;

        // Add empty cells for days before the 1st of the month
        for (let i = 0; i < firstDayOfMonth; i++) {
            calendarHtml += `<div class="calendar-day other-month"></div>`;
        }

        // Add cells for each day of the month
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(year, month, day);
            const isToday = today.toDateString() === currentDate.toDateString();
            const dateStr = currentDate.toISOString().split('T')[0];

            const wosOnThisDay = workOrders.filter(wo => wo.dueDate === dateStr);
            const hasEvents = wosOnThisDay.length > 0;

            calendarHtml += `
                <div class="calendar-day p-2 ${isToday ? 'today' : ''} ${hasEvents ? 'cursor-pointer hover:bg-blue-100' : ''}" ${hasEvents ? `data-date="${dateStr}"` : ''}>
                    <div class="font-bold">${day}</div>
                    <div class="mt-1 space-y-1 overflow-y-auto max-h-20 pointer-events-none">
                    ${wosOnThisDay.map(wo => {
                        const priorityColor = { High: 'bg-red-100', Medium: 'bg-yellow-100', Low: 'bg-blue-100' }[wo.priority];
                        let statusDotColor = 'bg-gray-400'; // Default
                        if (wo.status === 'Completed') {
                            statusDotColor = 'bg-green-500';
                        } else if (wo.status === 'Delay') {
                            statusDotColor = 'bg-red-500';
                        } else if (['Open', 'In Progress', 'On Hold'].includes(wo.status)) {
                            statusDotColor = 'bg-yellow-500'; // Pending
                        }
                        return `<div class="text-xs p-1 rounded ${priorityColor} flex items-center" title="${wo.title} - Status: ${wo.status}">
                                    <span class="inline-block w-2 h-2 ${statusDotColor} rounded-full mr-1.5 flex-shrink-0"></span>
                                    <span class="truncate">${wo.title}</span>
                                </div>`;
                    }).join('')}
                    </div>
                </div>
            `;
        }
        
        // Add empty cells for days after the end of the month to fill the grid
        const lastDayOfMonth = new Date(year, month, daysInMonth).getDay();
        for(let i = lastDayOfMonth; i < 6; i++) {
            calendarHtml += `<div class="calendar-day other-month"></div>`;
        }


        calendarHtml += `</div></div>`;
        return calendarHtml;
    }

    function renderLocationsPage() {
        const { divisions = [], departments = [], productionLines = [], cabinets = [], shelves = [], boxes = [] } = db.get('locations') || {};
        const isAdmin = state.currentUser.role === 'Admin';

        return `
            <h1 class="text-3xl font-bold mb-6">Location Management</h1>
            <div class="grid grid-cols-1 ${isAdmin ? 'md:grid-cols-3' : ''} gap-6">
                
                ${isAdmin ? `
                <div class="bg-white p-4 rounded-lg shadow space-y-6">
                    <div>
                        <h2 class="text-xl font-bold mb-4">Divisions</h2>
                        <ul id="divisionList" class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                            ${divisions.map(d => `
                                <li class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span>${d.name}</span>
                                    <button class="delete-division-btn text-red-500 hover:text-red-700" data-id="${d.id}"><i class="fas fa-trash"></i></button>
                                </li>`).join('') || '<li class="text-gray-500">No divisions found.</li>'}
                        </ul>
                        <form id="addDivisionForm" class="flex gap-2 border-t pt-4">
                            <input type="text" id="newDivisionName" class="flex-grow px-2 py-1 border rounded" placeholder="New Division Name" required>
                            <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded">+</button>
                        </form>
                    </div>

                    <div>
                        <h2 class="text-xl font-bold mb-4">Departments</h2>
                        <ul id="departmentList" class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                            ${departments.map(d => {
                                const division = divisions.find(div => div.id === d.divisionId);
                                return `
                                <li class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <div>
                                        <p>${d.name}</p>
                                        <p class="text-xs text-gray-500">${division ? division.name : 'No Division'}</p>
                                    </div>
                                    <button class="delete-department-btn text-red-500 hover:text-red-700" data-id="${d.id}"><i class="fas fa-trash"></i></button>
                                </li>`;
                            }).join('') || '<li class="text-gray-500">No departments found.</li>'}
                        </ul>
                        <form id="addDepartmentForm" class="border-t pt-4">
                            <select id="departmentDivisionSelect" class="w-full mb-2 px-2 py-1 border rounded" required>
                                <option value="">Select Division</option>
                                ${divisions.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                            </select>
                            <div class="flex gap-2">
                                <input type="text" id="newDepartmentName" class="flex-grow px-2 py-1 border rounded" placeholder="New Department Name" required>
                                <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded">+</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Production Lines</h2>
                    <ul id="productionLineList" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
                        ${productionLines.map(pl => {
                            const department = departments.find(d => d.id === pl.departmentId);
                            return `
                            <li class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <div>
                                    <p>${pl.name}</p>
                                    <p class="text-xs text-gray-500">${department ? department.name : 'No Department'}</p>
                                </div>
                                <button class="delete-pline-btn text-red-500 hover:text-red-700" data-id="${pl.id}"><i class="fas fa-trash"></i></button>
                            </li>`;
                        }).join('') || '<li class="text-gray-500">No production lines found.</li>'}
                    </ul>
                    <form id="addProductionLineForm" class="border-t pt-4">
                        <h3 class="font-semibold mb-2">Add New Production Line</h3>
                        <select id="productionLineDepartmentSelect" class="w-full mb-2 px-2 py-1 border rounded" required>
                            <option value="">Select Department</option>
                            ${departments.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                        </select>
                        <div class="flex gap-2">
                            <input type="text" id="newProductionLineName" class="flex-grow px-2 py-1 border rounded" placeholder="New Line Name" required>
                            <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded">+</button>
                        </div>
                    </form>
                </div>
                ` : ''}

                <div class="bg-white p-4 rounded-lg shadow space-y-4">
                    <h2 class="text-xl font-bold mb-2">Storage Locations</h2>
                     <div>
                        <h3 class="font-semibold mb-2">Cabinets</h3>
                         <ul id="cabinetList" class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                            ${cabinets.map(c => {
                                const department = departments.find(d => d.id === c.departmentId);
                                return `<li class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span>${c.name} <span class="text-xs text-gray-500">(${department ? department.name : 'N/A'})</span></span>
                                    <button class="delete-cabinet-btn text-red-500 hover:text-red-700" data-id="${c.id}"><i class="fas fa-trash"></i></button>
                                </li>`
                            }).join('') || '<li class="text-gray-500">No cabinets found.</li>'}
                        </ul>
                        <form id="addCabinetForm" class="border-t pt-2">
                            <select id="cabinetDepartmentSelect" class="w-full mb-2 px-2 py-1 border rounded" required>
                                <option value="">Select Department</option>
                                ${departments.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                            </select>
                            <div class="flex gap-2">
                                <input type="text" id="newCabinetName" class="flex-grow px-2 py-1 border rounded" placeholder="New Cabinet Name" required>
                                <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded">+</button>
                            </div>
                        </form>
                    </div>
                     <div>
                        <h3 class="font-semibold mb-2">Shelves</h3>
                         <ul id="shelfList" class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                            ${shelves.map(s => {
                                const cabinet = cabinets.find(c => c.id === s.cabinetId);
                                return `<li class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span>${s.name} <span class="text-xs text-gray-500">(${cabinet ? cabinet.name : 'N/A'})</span></span>
                                    <button class="delete-shelf-btn text-red-500 hover:text-red-700" data-id="${s.id}"><i class="fas fa-trash"></i></button>
                                </li>`
                            }).join('') || '<li class="text-gray-500">No shelves found.</li>'}
                        </ul>
                        <form id="addShelfForm" class="border-t pt-2">
                            <select id="shelfCabinetSelect" class="w-full mb-2 px-2 py-1 border rounded" required>
                                <option value="">Select Cabinet</option>
                                ${cabinets.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                            <div class="flex gap-2">
                                <input type="text" id="newShelfName" class="flex-grow px-2 py-1 border rounded" placeholder="New Shelf Name" required>
                                <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded">+</button>
                            </div>
                        </form>
                    </div>
                     <div>
                        <h3 class="font-semibold mb-2">Boxes</h3>
                         <ul id="boxList" class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                            ${boxes.map(b => {
                                const shelf = shelves.find(s => s.id === b.shelfId);
                                return `<li class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span>${b.name} <span class="text-xs text-gray-500">(${shelf ? shelf.name : 'N/A'})</span></span>
                                    <button class="delete-box-btn text-red-500 hover:text-red-700" data-id="${b.id}"><i class="fas fa-trash"></i></button>
                                </li>`
                            }).join('') || '<li class="text-gray-500">No boxes found.</li>'}
                        </ul>
                        <form id="addBoxForm" class="border-t pt-2">
                            <select id="boxShelfSelect" class="w-full mb-2 px-2 py-1 border rounded" required>
                                <option value="">Select Shelf</option>
                                ${shelves.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                            </select>
                            <div class="flex gap-2">
                                <input type="text" id="newBoxName" class="flex-grow px-2 py-1 border rounded" placeholder="New Box Name" required>
                                <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded">+</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
    }

    function renderUserManagementPage() {
        const users = db.get('users');
        return `
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">User Management</h1>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="overflow-x-auto">
                    <table class="w-full" id="userTable">
                        <thead><tr class="border-b">
                            <th class="p-2 text-left">Full Name</th>
                            <th class="p-2 text-left">Username</th>
                            <th class="p-2 text-left">Role</th>
                            <th class="p-2 text-left">Department</th>
                            <th class="p-2 text-left">Actions</th>
                        </tr></thead>
                        <tbody>
                            ${users.map(user => {
                                const department = getUserDepartment(user);
                                return `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-2">${user.fullName}</td>
                                    <td class="p-2">${user.username}</td>
                                    <td class="p-2">${user.role}</td>
                                    <td class="p-2">${department}</td>
                                    <td class="p-2">
                                        ${user.role !== 'Admin' ? `<button class="delete-user-btn text-red-500 hover:text-red-700" data-id="${user.id}"><i class="fas fa-trash"></i></button>` : ''}
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    function renderActivityLogPage() {
        const logs = db.get('logs');
        return `
            <h1 class="text-3xl font-bold mb-6">Activity Log</h1>
            <div class="bg-white p-4 rounded-lg shadow">
                <ul class="space-y-4">
                    ${logs.map(log => `
                        <li class="border-b pb-2">
                            <p class="font-semibold">${log.action} <span class="font-normal text-gray-600">by ${log.user}</span></p>
                            <p class="text-sm text-gray-500">${new Date(log.timestamp).toLocaleString()}</p>
                            ${log.details ? `<p class="text-sm mt-1 text-gray-700">${log.details}</p>` : ''}
                        </li>
                    `).join('')}
                </ul>
            </div>
        `;
    }

    function generateTableRows(type, data) {
        if (!data || data.length === 0) {
            return `<tr><td colspan="10" class="text-center p-4 text-gray-500">No data available.</td></tr>`;
        }

        data.sort((a, b) => {
            let valA = a[state.sortKey];
            let valB = b[state.sortKey];
            
            if (state.sortKey === 'locationId') {
                valA = getFullLocationName(a.locationId);
                valB = getFullLocationName(b.locationId);
            }
            if (state.sortKey === 'assetId') {
                valA = db.get('assets').find(asset => asset.id === a.assetId)?.name || '';
                valB = db.get('assets').find(asset => asset.id === b.assetId)?.name || '';
            }

            if (typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            }

            if (valA < valB) return state.sortOrder === 'asc' ? -1 : 1;
            if (valA > valB) return state.sortOrder === 'asc' ? 1 : -1;
            return 0;
        });

        switch (type) {
            case 'assets':
                return data.map(asset => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2">${asset.name}</td>
                        <td class="p-2">${asset.tag}</td>
                        <td class="p-2">${getFullLocationName(asset.locationId)}</td>
                        <td class="p-2">
                          <span class="px-2 py-1 text-xs font-semibold rounded-full ${asset.status === 'Active' ? 'bg-green-200 text-green-800' : asset.status === 'Decommissioned' ? 'bg-gray-200 text-gray-800' : 'bg-yellow-200 text-yellow-800'}">
                            ${asset.status}
                          </span>
                        </td>
                        <td class="p-2 space-x-2">
                            <button class="view-asset-btn text-blue-500 hover:text-blue-700" data-id="${asset.id}" title="View Details"><i class="fas fa-eye"></i></button>
                            <button class="edit-asset-btn text-yellow-500 hover:text-yellow-700" data-id="${asset.id}" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="transfer-asset-btn text-purple-500 hover:text-purple-700" data-id="${asset.id}" title="Transfer"><i class="fas fa-truck"></i></button>
                            <button class="delete-asset-btn text-red-500 hover:text-red-700" data-id="${asset.id}" title="Delete"><i class="fas fa-trash"></i></button>
                            ${asset.status !== 'Decommissioned' ? `<button class="dispose-asset-btn text-gray-500 hover:text-gray-700" data-id="${asset.id}" title="Dispose"><i class="fas fa-ban"></i></button>` : ''}
                        </td>
                    </tr>`).join('');
            case 'parts':
                return data.map(part => `
                    <tr class="border-b hover:bg-gray-50 ${part.quantity <= part.minQuantity ? 'bg-red-100' : ''}">
                        <td class="p-2">${part.name}</td>
                        <td class="p-2">${part.sku}</td>
                        <td class="p-2">${part.category || 'N/A'}</td>
                        <td class="p-2">${part.supplier || 'N/A'}</td>
                        <td class="p-2">${part.quantity} ${part.quantity <= part.minQuantity ? '<span class="text-red-600 font-bold">(Low)</span>' : ''}</td>
                        <td class="p-2">${part.price ? `${part.currency || ''} ${part.price.toFixed(2)}` : 'N/A'}</td>
                        <td class="p-2 space-x-2">
                            <button class="view-part-btn text-blue-500 hover:text-blue-700" data-id="${part.id}" title="View Details"><i class="fas fa-eye"></i></button>
                            <button class="edit-part-btn text-yellow-500 hover:text-yellow-700" data-id="${part.id}" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="delete-part-btn text-red-500 hover:text-red-700" data-id="${part.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join('');
            case 'partRequests':
                const parts = db.get('parts');
                const users = db.get('users');
                const statusColors = {
                    'Requested': 'bg-blue-200 text-blue-800',
                    'Requested from Storage': 'bg-cyan-200 text-cyan-800',
                    'Approved': 'bg-yellow-200 text-yellow-800',
                    'Rejected': 'bg-red-200 text-red-800',
                    'Received': 'bg-green-200 text-green-800',
                    'Completed': 'bg-gray-400 text-gray-800'
                };
                 return data.map(req => {
                    const part = req.partId ? parts.find(p => p.id === req.partId) : null;
                    const partName = part ? part.name : `<span class="italic text-gray-500">${req.newPartName} (New)</span>`;
                    const partNumber = req.newPartNumber || (part ? part.sku : 'N/A');
                    const maker = req.newPartMaker || (part ? part.maker : 'N/A');
                    const user = users.find(u => u.id === req.requesterId);
                    const statusColorClass = statusColors[req.status] || 'bg-gray-200 text-gray-800';
                    return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2">${partName}</td>
                        <td class="p-2">${partNumber}</td>
                        <td class="p-2">${maker}</td>
                        <td class="p-2">${req.quantity}</td>
                        <td class="p-2">${req.purpose}</td>
                        <td class="p-2">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColorClass}">
                                ${req.status}
                            </span>
                        </td>
                        <td class="p-2 space-x-2">
                            ${(state.currentUser.role === 'Admin' || state.currentUser.role === 'Manager') && (req.status === 'Requested' || req.status === 'Requested from Storage') ? `
                                <button class="approve-pr-btn text-green-500 hover:text-green-700" data-id="${req.id}" title="Approve"><i class="fas fa-check"></i></button>
                                <button class="reject-pr-btn text-red-500 hover:text-red-700" data-id="${req.id}" title="Reject"><i class="fas fa-times"></i></button>
                            ` : ''}
                        </td>
                    </tr>
                `}).join('');
            case 'workOrders':
                const woStatusColors = {
                    Open: 'bg-blue-200 text-blue-800',
                    'In Progress': 'bg-yellow-200 text-yellow-800',
                    'On Hold': 'bg-orange-200 text-orange-800',
                    'Delay': 'bg-red-200 text-red-800',
                    Completed: 'bg-green-200 text-green-800'
                };
                return data.map(wo => {
                    const assetName = db.get('assets').find(a => a.id === wo.assetId)?.name || 'N/A';
                    const priorityColor = { High: 'text-red-600', Medium: 'text-yellow-600', Low: 'text-blue-600' }[wo.priority];
                    const statusColorClass = woStatusColors[wo.status] || 'bg-gray-200 text-gray-800';
                    return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2">${wo.title}</td>
                        <td class="p-2">${assetName}</td>
                        <td class="p-2">${wo.dueDate}</td>
                        <td class="p-2 font-bold ${priorityColor}">${wo.priority}</td>
                        <td class="p-2">
                           <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColorClass}">
                            ${wo.status}
                           </span>
                        </td>
                        <td class="p-2 space-x-2">
                            <button class="view-wo-btn text-blue-500 hover:text-blue-700" data-id="${wo.id}" title="View Details"><i class="fas fa-eye"></i></button>
                            ${wo.status !== 'Completed' ? `<button class="complete-wo-btn text-green-500 hover:text-green-700" data-id="${wo.id}" title="Complete"><i class="fas fa-check-circle"></i></button>` : ''}
                            <button class="edit-wo-btn text-yellow-500 hover:text-yellow-700" data-id="${wo.id}" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="delete-wo-btn text-red-500 hover:text-red-700" data-id="${wo.id}" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                }).join('');
        }
    }
    
    // --- UI HELPER FUNCTIONS ---
    
    function addChecklistItem(text) {
        const container = document.getElementById('woChecklistContainer');
        const itemDiv = document.createElement('div');
        itemDiv.className = 'flex items-center gap-2 checklist-item';
        itemDiv.innerHTML = `
            <span class="flex-grow p-2 bg-gray-100 rounded">${text}</span>
            <button type="button" class="remove-checklist-item-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
        `;
        container.appendChild(itemDiv);
    }

    function addWoPartRow(selectedPartId = '', quantity = 1) {
        const container = document.getElementById('woPartsContainer');
        const allParts = db.get('parts');
        
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2 wo-part-row';
        
        const select = document.createElement('select');
        select.className = 'w-2/3 px-3 py-2 border rounded wo-part-select';
        select.innerHTML = '<option value="">Select a part...</option>' + allParts.map(p => `<option value="${p.id}">${p.name} (SKU: ${p.sku})</option>`).join('');
        select.value = selectedPartId;

        const qtyInput = document.createElement('input');
        qtyInput.type = 'number';
        qtyInput.className = 'w-1/3 px-3 py-2 border rounded wo-part-qty';
        qtyInput.value = quantity;
        qtyInput.min = 1;
        qtyInput.placeholder = 'Qty';

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-wo-part-btn text-red-500 hover:text-red-700';
        removeBtn.innerHTML = '<i class="fas fa-trash"></i>';

        row.appendChild(select);
        row.appendChild(qtyInput);
        row.appendChild(removeBtn);
        container.appendChild(row);
    }

    function populateLocationDropdowns(divisionSelect, departmentSelect) {
        const { divisions = [], departments = [] } = db.get('locations') || {};
        divisionSelect.innerHTML = `<option value="">Select Division</option>` + divisions.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
        departmentSelect.innerHTML = `<option value="">Select Department</option>`;
        
        divisionSelect.addEventListener('change', () => {
            const selectedDivisionId = parseInt(divisionSelect.value);
            const filteredDepartments = departments.filter(d => d.divisionId === selectedDivisionId);
            departmentSelect.innerHTML = `<option value="">Select Department</option>` + filteredDepartments.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
        });
    }

    function populateLocationDropdown(selectElement, type = 'all') {
        const { productionLines = [], cabinets = [], shelves = [], boxes = [] } = db.get('locations') || {};
        let options = '<option value="">Select a location</option>';
        
        if (type === 'all' || type === 'operational') {
            const filteredOpLocations = (state.currentUser.role === 'Admin' ?
                productionLines :
                productionLines.filter(loc => loc.departmentId === state.currentUser.departmentId)
            ).map(loc => `<option value="pl-${loc.id}">${getFullLocationName(`pl-${loc.id}`)}</option>`).join('');

            if (filteredOpLocations) {
                options += `<optgroup label="Production Lines">${filteredOpLocations}</optgroup>`;
            }
        }

        if (type === 'all' || type === 'storage') {
            const filteredCabinets = (state.currentUser.role === 'Admin' ?
                cabinets :
                cabinets.filter(loc => loc.departmentId === state.currentUser.departmentId)
            ).map(loc => `<option value="cab-${loc.id}">${getFullLocationName(`cab-${loc.id}`)}</option>`).join('');
            if(filteredCabinets) options += `<optgroup label="Cabinets">${filteredCabinets}</optgroup>`;

            const filteredShelves = (state.currentUser.role === 'Admin' ?
                shelves :
                shelves.filter(shelf => {
                    const cabinet = cabinets.find(c => c.id === shelf.cabinetId);
                    return cabinet && cabinet.departmentId === state.currentUser.departmentId;
                })
            ).map(loc => `<option value="sh-${loc.id}">${getFullLocationName(`sh-${loc.id}`)}</option>`).join('');
            if(filteredShelves) options += `<optgroup label="Shelves">${filteredShelves}</optgroup>`;

            const filteredBoxes = (state.currentUser.role === 'Admin' ?
                boxes :
                boxes.filter(box => {
                    const shelf = shelves.find(s => s.id === box.shelfId);
                    const cabinet = shelf ? cabinets.find(c => c.id === shelf.cabinetId) : null;
                    return cabinet && cabinet.departmentId === state.currentUser.departmentId;
                })
            ).map(box => `<option value="box-${box.id}">${getFullLocationName(`box-${box.id}`)}</option>`).join('');

            if (filteredBoxes) {
                options += `<optgroup label="Boxes">${filteredBoxes}</optgroup>`;
            }
        }

        selectElement.innerHTML = options;
    }
    
    // --- MODAL DISPLAY FUNCTIONS ---

    function showAssetModal(assetId = null) {
        const form = document.getElementById('assetForm');
        form.reset();
        document.getElementById('assetId').value = '';
        
        populateLocationDropdown(document.getElementById('assetLocation'), 'operational');
        
        const allParts = db.get('parts');
        document.getElementById('assetRelatedParts').innerHTML = allParts.map(p => `<option value="${p.id}">${p.name} (SKU: ${p.sku})</option>`).join('');

        if (assetId) {
            const asset = db.get('assets').find(a => a.id === assetId);
            if (asset) {
                document.getElementById('assetModalTitle').textContent = 'Edit Asset';
                document.getElementById('assetId').value = asset.id;
                document.getElementById('assetName').value = asset.name;
                document.getElementById('assetTag').value = asset.tag;
                document.getElementById('assetCategory').value = asset.category;
                document.getElementById('assetPurchaseDate').value = asset.purchaseDate;
                document.getElementById('assetCost').value = asset.cost;
                document.getElementById('assetCurrency').value = asset.currency;
                document.getElementById('assetLocation').value = asset.locationId;
                
                const relatedPartIds = allParts.filter(p => p.relatedAssetIds && p.relatedAssetIds.includes(asset.id)).map(p => p.id);
                Array.from(document.getElementById('assetRelatedParts').options).forEach(option => {
                    if (relatedPartIds.includes(parseInt(option.value))) {
                        option.selected = true;
                    }
                });
            }
        } else {
            document.getElementById('assetModalTitle').textContent = 'Add Asset';
        }
        document.getElementById('assetModal').style.display = 'flex';
    }

    function showPartModal(partId = null) {
        const form = document.getElementById('partForm');
        form.reset();
        document.getElementById('partId').value = '';
        
        populateLocationDropdown(document.getElementById('partLocation'), 'storage');
        
        const allAssets = db.get('assets').filter(can.view);
        document.getElementById('partRelatedAssets').innerHTML = allAssets.map(a => `<option value="${a.id}">${a.name} (Tag: ${a.tag})</option>`).join('');

        const allParts = db.get('parts');
        document.getElementById('partNameList').innerHTML = [...new Set(allParts.map(p => p.name))].map(name => `<option value="${name}">`).join('');
        document.getElementById('partMakerList').innerHTML = [...new Set(allParts.map(p => p.maker).filter(Boolean))].map(maker => `<option value="${maker}">`).join('');

        if (partId) {
            const part = allParts.find(p => p.id === partId);
            if (part) {
                document.getElementById('partModalTitle').textContent = 'Edit Spare Part';
                document.getElementById('partId').value = part.id;
                document.getElementById('originalPartQuantity').value = part.quantity;
                document.getElementById('partCategory').value = part.category;
                document.getElementById('partName').value = part.name;
                document.getElementById('partMaker').value = part.maker;
                document.getElementById('partSku').value = part.sku;
                document.getElementById('partQuantity').value = part.quantity;
                document.getElementById('partMinQuantity').value = part.minQuantity;
                document.getElementById('partSupplier').value = part.supplier;
                document.getElementById('partPrice').value = part.price;
                document.getElementById('partCurrency').value = part.currency;
                document.getElementById('partLeadTime').value = part.leadTime;
                document.getElementById('partLocation').value = part.locationId;
                document.getElementById('partAttachmentRef').value = part.attachmentRef;
                
                if (part.relatedAssetIds) {
                    Array.from(document.getElementById('partRelatedAssets').options).forEach(option => {
                        if (part.relatedAssetIds.includes(parseInt(option.value))) {
                            option.selected = true;
                        }
                    });
                }
            }
        } else {
            document.getElementById('partModalTitle').textContent = 'Add Spare Part';
            document.getElementById('originalPartQuantity').value = 0;
        }
        document.getElementById('partModal').style.display = 'flex';
    }

    function showWorkOrderModal(woId = null, isUrgent = false) {
        const form = document.getElementById('workOrderForm');
        form.reset();
        document.getElementById('workOrderId').value = '';
        document.getElementById('woChecklistContainer').innerHTML = '';
        document.getElementById('woPartsContainer').innerHTML = '';
        document.getElementById('woPartsSection').style.display = 'none';

        const assets = db.get('assets').filter(can.view);
        document.getElementById('woAsset').innerHTML = assets.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        
        const users = db.get('users').filter(u => ['Engineer', 'Technician', 'Supervisor'].includes(u.role) && can.view(u));
        document.getElementById('woAssignedTo').innerHTML = users.map(u => `<option value="${u.id}">${u.fullName}</option>`).join('');

        document.getElementById('woTask').addEventListener('change', (e) => {
            const task = e.target.value;
            const partsSection = document.getElementById('woPartsSection');
            partsSection.style.display = (task === 'Replacement' || task === 'Assemble') ? 'block' : 'none';
        });

        document.getElementById('addWoPartBtn').addEventListener('click', () => addWoPartRow());

        if (woId) {
            const wo = db.get('workOrders').find(w => w.id === woId);
            if (wo) {
                document.getElementById('workOrderModalTitle').textContent = 'Edit Work Order';
                document.getElementById('workOrderId').value = wo.id;
                document.getElementById('woTitle').value = wo.title;
                document.getElementById('woDescription').value = wo.description;
                document.getElementById('woAsset').value = wo.assetId;
                document.getElementById('woAssignedTo').value = wo.assignedTo;
                document.getElementById('woTask').value = wo.task;
                document.getElementById('woDueDate').value = wo.dueDate;
                document.getElementById('woBreakdownTime').value = wo.breakdownTimestamp || '';
                document.getElementById('woPriority').value = wo.priority;
                document.getElementById('woFrequency').value = wo.frequency;
                document.getElementById('woStatus').value = wo.status;

                if (wo.checklist) {
                    wo.checklist.forEach(item => addChecklistItem(item.text));
                }
                if (wo.requiredParts && wo.requiredParts.length > 0) {
                    document.getElementById('woPartsSection').style.display = 'block';
                    wo.requiredParts.forEach(part => addWoPartRow(part.partId, part.quantity));
                }
            }
        } else {
            document.getElementById('workOrderModalTitle').textContent = 'Create Work Order';
            if (isUrgent) {
                document.getElementById('woPriority').value = 'High';
                document.getElementById('woFrequency').value = 'One-Time';
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('woBreakdownTime').value = now.toISOString().slice(0,16);
            }
        }
        document.getElementById('workOrderModal').style.display = 'flex';
    }
    
    function showPartRequestModal() {
        const form = document.getElementById('partRequestForm');
        form.reset();
        
        const parts = db.get('parts').filter(can.view);
        document.getElementById('requestPartId').innerHTML = '<option value="">Select an existing part</option>' + parts.map(p => `<option value="${p.id}">${p.name} (Stock: ${p.quantity})</option>`).join('');
        
        document.getElementById('requestNewPartCheckbox').checked = false;
        document.getElementById('existingPartContainer').style.display = 'block';
        document.getElementById('newPartContainer').style.display = 'none';

        document.getElementById('requestNewPartCheckbox').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            document.getElementById('existingPartContainer').style.display = isChecked ? 'none' : 'block';
            document.getElementById('newPartContainer').style.display = isChecked ? 'block' : 'none';
        });

        document.getElementById('partRequestModal').style.display = 'flex';
    }

    function showStorageRequestModal() {
        const form = document.getElementById('storageRequestForm');
        form.reset();
        const parts = db.get('parts').filter(p => can.view(p) && p.quantity > 0);
        document.getElementById('storageRequestPartId').innerHTML = '<option value="">Select a part from storage</option>' + parts.map(p => `<option value="${p.id}">${p.name} (Stock: ${p.quantity})</option>`).join('');
        document.getElementById('storageRequestModal').style.display = 'flex';
    }

    function showReceivePartsModal() {
        const approvedRequests = db.get('partRequests').filter(pr => pr.status === 'Approved');
        if (approvedRequests.length === 0) {
            showTemporaryMessage('No approved requests to receive.', true);
            return;
        }
        document.getElementById('receiveRequestId').innerHTML = approvedRequests.map(pr => `<option value="${pr.id}">Req #${pr.id}: ${pr.quantity} x ${pr.newPartName}</option>`).join('');
        document.getElementById('receivePartsModal').style.display = 'flex';
    }

    function showRestockPartsModal() {
        const receivedParts = db.get('receivedParts');
        if (receivedParts.length === 0) {
            showTemporaryMessage('No received parts to restock.', true);
            return;
        }
        document.getElementById('restockPartId').innerHTML = receivedParts.map(rp => `<option value="${rp.id}">Req #${rp.requestId}: ${rp.quantity} x ${rp.newPartName}</option>`).join('');
        populateLocationDropdown(document.getElementById('restockLocationId'), 'storage');
        document.getElementById('restockPartsModal').style.display = 'flex';
    }

    function showCompleteWorkOrderModal(woId) {
        const wo = db.get('workOrders').find(w => w.id === woId);
        if (!wo) return;

        document.getElementById('completeWorkOrderId').value = wo.id;
        document.getElementById('completeWoTitle').textContent = wo.title;
        
        const checklistContainer = document.getElementById('completeWoChecklist');
        if (wo.checklist && wo.checklist.length > 0) {
            checklistContainer.innerHTML = wo.checklist.map(item => `
                <label class="flex items-center">
                    <input type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="ml-2 text-gray-700">${item.text}</span>
                </label>
            `).join('');
        } else {
            checklistContainer.innerHTML = '<p class="text-gray-500">No checklist for this work order.</p>';
        }
        
        document.getElementById('completionNotes').value = '';
        document.getElementById('completeWorkOrderModal').style.display = 'flex';
    }

    function showCalendarDetailModal(date, workOrders) {
        document.getElementById('calendarDetailModalTitle').textContent = `Work Orders for ${date}`;
        const contentEl = document.getElementById('calendarDetailContent');
        
        if (workOrders.length === 0) {
            contentEl.innerHTML = '<p>No work orders scheduled for this day.</p>';
        } else {
            contentEl.innerHTML = workOrders.map(wo => {
                const asset = db.get('assets').find(a => a.id === wo.assetId);
                return `
                    <div class="p-3 border rounded-lg hover:bg-gray-50">
                        <p class="font-bold">${wo.title}</p>
                        <p class="text-sm"><strong>Asset:</strong> ${asset ? asset.name : 'N/A'}</p>
                        <p class="text-sm"><strong>Status:</strong> ${wo.status}</p>
                        <p class="text-sm"><strong>Priority:</strong> ${wo.priority}</p>
                    </div>
                `;
            }).join('');
        }
        
        document.getElementById('calendarDetailModal').style.display = 'flex';
    }

    function showTransferAssetModal(assetId) {
        const asset = db.get('assets').find(a => a.id === assetId);
        if (!asset) return;

        document.getElementById('transferAssetId').value = asset.id;
        document.getElementById('transferAssetName').textContent = asset.name;
        
        const locationSelect = document.getElementById('transferLocation');
        populateLocationDropdown(locationSelect, 'operational');
        // Filter out the current location
        locationSelect.innerHTML = Array.from(locationSelect.options).filter(opt => opt.value !== asset.locationId).map(opt => opt.outerHTML).join('');

        document.getElementById('transferNotes').value = '';
        document.getElementById('transferAssetModal').style.display = 'flex';
    }

    function showAssetDetailModal(assetId) {
        const asset = db.get('assets').find(a => a.id === assetId);
        if (!asset) return;
        
        const workOrders = db.get('workOrders').filter(wo => wo.assetId === assetId);
        const allParts = db.get('parts');
        const relatedParts = allParts.filter(p => p.relatedAssetIds && p.relatedAssetIds.includes(asset.id));

        const content = `
            <h2 class="text-2xl font-bold mb-4">${asset.name} <span class="text-base font-normal text-gray-500">(${asset.tag})</span></h2>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div><strong class="text-gray-600">Category:</strong> ${asset.category}</div>
                <div><strong class="text-gray-600">Status:</strong> ${asset.status}</div>
                <div><strong class="text-gray-600">Location:</strong> ${getFullLocationName(asset.locationId)}</div>
                <div><strong class="text-gray-600">Purchase Date:</strong> ${asset.purchaseDate}</div>
                <div><strong class="text-gray-600">Cost:</strong> ${asset.currency} ${asset.cost.toLocaleString()}</div>
            </div>
            
            <h3 class="text-xl font-bold mb-2">Related Spare Parts</h3>
            <div class="max-h-48 overflow-y-auto border rounded p-2 mb-6">
                 ${relatedParts.length > 0 ? `<ul>${relatedParts.map(p => `
                    <li class="border-b py-1"><strong>${p.name}</strong> (SKU: ${p.sku})</li>
                `).join('')}</ul>` : `<p class="text-gray-500">No related spare parts found.</p>`}
            </div>

            <h3 class="text-xl font-bold mb-2">Work Order History</h3>
            <div class="max-h-48 overflow-y-auto border rounded p-2 mb-6">
                ${workOrders.length > 0 ? `<ul>${workOrders.map(wo => `
                    <li class="border-b py-1"><strong>${wo.title}</strong> - Due: ${wo.dueDate}, Status: ${wo.status}</li>
                `).join('')}</ul>` : `<p class="text-gray-500">No work orders found.</p>`}
            </div>

            <h3 class="text-xl font-bold mb-2">Transfer History</h3>
            <div class="max-h-48 overflow-y-auto border rounded p-2">
                ${asset.transferHistory && asset.transferHistory.length > 0 ? `<ul>${asset.transferHistory.map(t => `
                    <li class="border-b py-1">
                        Moved to <strong>${getFullLocationName(t.toLocationId)}</strong> on ${new Date(t.date).toLocaleDateString()}
                        <p class="text-sm text-gray-600">By: ${t.user} | Notes: ${t.notes || 'N/A'}</p>
                    </li>
                `).join('')}</ul>` : `<p class="text-gray-500">No transfer history.</p>`}
            </div>
        `;
        document.getElementById('assetDetailContent').innerHTML = content;
        document.getElementById('assetDetailModal').style.display = 'flex';
    }

    function showPartDetailModal(partId) {
        const part = db.get('parts').find(p => p.id === partId);
        if (!part) return;

        const allAssets = db.get('assets');
        const relatedAssets = part.relatedAssetIds ? allAssets.filter(a => part.relatedAssetIds.includes(a.id)) : [];

        const content = `
            <h2 class="text-2xl font-bold mb-4">${part.name} <span class="text-base font-normal text-gray-500">(${part.sku})</span></h2>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div><strong class="text-gray-600">Category:</strong> ${part.category}</div>
                <div><strong class="text-gray-600">Maker:</strong> ${part.maker || 'N/A'}</div>
                <div><strong class="text-gray-600">Quantity:</strong> ${part.quantity}</div>
                <div><strong class="text-gray-600">Low Stock At:</strong> ${part.minQuantity}</div>
                <div><strong class="text-gray-600">Price:</strong> ${part.currency} ${part.price ? part.price.toFixed(2) : 'N/A'}</div>
                <div><strong class="text-gray-600">Supplier:</strong> ${part.supplier || 'N/A'}</div>
                <div class="col-span-2"><strong class="text-gray-600">Location:</strong> ${getFullLocationName(part.locationId)}</div>
                <div class="col-span-2"><strong class="text-gray-600">Attachment:</strong> ${part.attachmentRef ? `<a href="${part.attachmentRef}" target="_blank" class="text-blue-500 hover:underline">${part.attachmentRef}</a>` : 'N/A'}</div>
            </div>
            
            <h3 class="text-xl font-bold mb-2">Related Assets</h3>
            <div class="max-h-48 overflow-y-auto border rounded p-2 mb-6">
                ${relatedAssets.length > 0 ? `<ul>${relatedAssets.map(a => `
                    <li class="border-b py-1"><strong>${a.name}</strong> (Tag: ${a.tag})</li>
                `).join('')}</ul>` : `<p class="text-gray-500">This part is not related to any assets.</p>`}
            </div>

            <h3 class="text-xl font-bold mb-2">Transaction History</h3>
            <div class="max-h-48 overflow-y-auto border rounded p-2">
                ${part.transactionHistory && part.transactionHistory.length > 0 ? `<ul>${part.transactionHistory.map(t => `
                    <li class="border-b py-2">
                        <p><strong>Type:</strong> <span class="${t.type === 'In' ? 'text-green-600' : 'text-red-600'}">${t.type}</span> | <strong>Qty:</strong> ${t.quantity}</p>
                        <p class="text-sm text-gray-600"><strong>Date:</strong> ${new Date(t.date).toLocaleString()}</p>
                        <p class="text-sm text-gray-600"><strong>User:</strong> ${t.user}</p>
                        <p class="text-sm text-gray-600"><strong>Details:</strong> ${t.details}</p>
                    </li>
                `).join('')}</ul>` : `<p class="text-gray-500">No transaction history.</p>`}
            </div>
        `;
        document.getElementById('partDetailContent').innerHTML = content;
        document.getElementById('partDetailModal').style.display = 'flex';
    }

    function showWorkOrderDetailModal(woId) {
        const wo = db.get('workOrders').find(w => w.id === woId);
        if (!wo) return;

        const asset = db.get('assets').find(a => a.id === wo.assetId);
        const assignedUser = db.get('users').find(u => u.id === wo.assignedTo);
        const allParts = db.get('parts');

        const content = `
            <h2 class="text-2xl font-bold mb-4">${wo.title}</h2>
            <div class="grid grid-cols-2 gap-x-4 gap-y-2 mb-6 text-sm">
                <div><strong class="text-gray-600">Status:</strong> <span class="font-semibold">${wo.status}</span></div>
                <div><strong class="text-gray-600">Priority:</strong> <span class="font-semibold">${wo.priority}</span></div>
                <div><strong class="text-gray-600">Asset:</strong> ${asset ? asset.name : 'N/A'}</div>
                <div><strong class="text-gray-600">Assigned To:</strong> ${assignedUser ? assignedUser.fullName : 'N/A'}</div>
                <div><strong class="text-gray-600">Due Date:</strong> ${wo.dueDate}</div>
                <div><strong class="text-gray-600">Task Type:</strong> ${wo.task}</div>
                ${wo.breakdownTimestamp ? `
                    <div class="col-span-2"><strong class="text-gray-600">Breakdown Time:</strong> ${new Date(wo.breakdownTimestamp).toLocaleString()}</div>
                ` : ''}
            </div>
            <div class="mb-6">
                <strong class="text-gray-600 block mb-1">Description:</strong>
                <p class="p-2 bg-gray-50 rounded border">${wo.description}</p>
            </div>
            
            <h3 class="text-lg font-bold mb-2">Checklist</h3>
            <div class="max-h-40 overflow-y-auto border rounded p-2 mb-6 bg-gray-50">
                ${wo.checklist && wo.checklist.length > 0 ? `<ul>${wo.checklist.map(item => `
                    <li class="py-1 flex items-center"><i class="far ${item.completed ? 'fa-check-square text-green-600' : 'fa-square'} mr-2"></i> ${item.text}</li>
                `).join('')}</ul>` : `<p class="text-gray-500">No checklist items.</p>`}
            </div>

            <h3 class="text-lg font-bold mb-2">Required Parts</h3>
            <div class="max-h-40 overflow-y-auto border rounded p-2">
                 ${wo.requiredParts && wo.requiredParts.length > 0 ? `<ul>${wo.requiredParts.map(rp => {
                    const part = allParts.find(p => p.id === rp.partId);
                    return `<li class="border-b py-1"><strong>${rp.quantity}x</strong> ${part ? part.name : `Part ID ${rp.partId}`} (SKU: ${part ? part.sku : 'N/A'})</li>`
                 }).join('')}</ul>` : `<p class="text-gray-500">No parts required.</p>`}
            </div>
            ${wo.completionNotes ? `
                <div class="mt-6">
                    <strong class="text-gray-600 block mb-1">Completion Notes:</strong>
                    <p class="p-2 bg-blue-50 rounded border border-blue-200">${wo.completionNotes}</p>
                </div>
            ` : ''}
        `;
        document.getElementById('workOrderDetailContent').innerHTML = content;
        document.getElementById('workOrderDetailModal').style.display = 'flex';
    }
    
    // =================================================================================
    //  PARTITION 5: MAIN RENDERER & NAVIGATION
    // =================================================================================

    function render() {
        if (!state.currentUser) {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
        } else {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            renderSidebar();
            renderMainContent();
        }
    }

    function renderSidebar() {
        const { fullName, role } = state.currentUser;
        document.getElementById('userFullName').textContent = fullName;
        document.getElementById('userRole').textContent = role;
        document.getElementById('userDepartment').textContent = getUserDepartment(state.currentUser);

        const navLinks = [
            { page: 'dashboard', icon: 'fa-tachometer-alt', text: 'Dashboard', roles: ['Admin', 'Manager', 'Supervisor', 'Engineer', 'Technician', 'Clerk'] },
            { page: 'assets', icon: 'fa-box', text: 'Assets', roles: ['Admin', 'Manager', 'Supervisor', 'Engineer', 'Technician'] },
            { page: 'parts', icon: 'fa-cogs', text: 'Spare Parts', roles: ['Admin', 'Manager', 'Supervisor', 'Engineer', 'Technician'] },
            { page: 'partRequests', icon: 'fa-inbox', text: 'Part Requests', roles: ['Admin', 'Manager', 'Supervisor', 'Engineer', 'Technician', 'Clerk'] },
            { page: 'workOrders', icon: 'fa-clipboard-list', text: 'Work Orders', roles: ['Admin', 'Manager', 'Supervisor', 'Engineer', 'Technician'] },
            { page: 'workOrderCalendar', icon: 'fa-calendar-alt', text: 'Calendar', roles: ['Admin', 'Manager', 'Supervisor', 'Engineer', 'Technician'] },
            { page: 'locations', icon: 'fa-map-marker-alt', text: 'Locations', roles: ['Admin', 'Manager', 'Supervisor'] },
            { page: 'userManagement', icon: 'fa-users-cog', text: 'User Management', roles: ['Admin'] },
            { page: 'activityLog', icon: 'fa-history', text: 'Activity Log', roles: ['Admin'] },
        ];

        const navMenu = document.getElementById('navMenu');
        navMenu.innerHTML = navLinks
            .filter(link => link.roles.includes(state.currentUser.role))
            .map(link => `
                <a href="#" class="nav-link flex items-center p-2 rounded-lg hover:bg-gray-700 ${state.currentPage === link.page ? 'bg-gray-900' : ''}" data-page="${link.page}">
                    <i class="fas ${link.icon} w-6 text-center"></i>
                    <span class="ml-3">${link.text}</span>
                </a>
            `).join('');
    }

    function renderMainContent() {
        const mainContent = document.getElementById('mainContent');
        let content = '';
        
        if (!can.viewPage(state.currentPage)) {
            state.currentPage = 'dashboard';
        }

        switch (state.currentPage) {
            case 'dashboard':
                content = renderDashboard();
                mainContent.innerHTML = content;
                break;
            case 'assets':
                content = renderAssetsPage();
                mainContent.innerHTML = content;
                attachAssetPageEventListeners();
                break;
            case 'parts':
                content = renderPartsPage();
                mainContent.innerHTML = content;
                attachPartsPageEventListeners();
                break;
            case 'partRequests':
                content = renderPartsRequestPage();
                mainContent.innerHTML = content;
                attachPartsRequestPageEventListeners();
                break;
            case 'workOrders':
                content = renderWorkOrdersPage();
                mainContent.innerHTML = content;
                attachWorkOrdersPageEventListeners();
                break;
            case 'workOrderCalendar':
                content = renderWorkOrderCalendar();
                mainContent.innerHTML = content;
                attachCalendarEventListeners();
                break;
            case 'locations':
                content = renderLocationsPage();
                mainContent.innerHTML = content;
                attachLocationsPageEventListeners();
                break;
            case 'userManagement':
                content = renderUserManagementPage();
                mainContent.innerHTML = content;
                attachUserManagementEventListeners();
                break;
            case 'activityLog':
                content = renderActivityLogPage();
                mainContent.innerHTML = content;
                break;
            default:
                content = renderDashboard();
                mainContent.innerHTML = content;
        }
        
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.toggle('bg-gray-900', link.dataset.page === state.currentPage);
        });
    }

    // =================================================================================
    //  PARTITION 6: EVENT HANDLERS & ACTION LOGIC
    // =================================================================================
    
    function handleLogin(e) {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const users = db.get('users');
        const user = users.find(u => u.username === username && u.password === password);

        if (user) {
            state.currentUser = user;
            document.getElementById('loginError').textContent = '';
            document.getElementById('loginForm').reset();
            logActivity('User Login');
            render();
        } else {
            document.getElementById('loginError').textContent = 'Invalid username or password.';
        }
    }

    function handleBypassLogin() {
        state.currentUser = db.get('users').find(u => u.username === 'admin');
        logActivity('Admin Bypass Login');
        render();
    }
    
    function handleLogout() {
        logActivity('User Logout');
        state.currentUser = null;
        state.currentPage = 'dashboard';
        render();
    }
    
    function handleRegistration(e) {
        e.preventDefault();
        const users = db.get('users');
        const username = document.getElementById('regUsername').value;
        
        if (users.some(u => u.username === username)) {
            document.getElementById('regError').textContent = 'Username already exists.';
            return;
        }

        const newUser = {
            id: getNextId('users'),
            fullName: document.getElementById('regFullName').value,
            employeeId: document.getElementById('regEmployeeId').value,
            username: username,
            password: document.getElementById('regPassword').value,
            divisionId: parseInt(document.getElementById('regDivision').value),
            departmentId: parseInt(document.getElementById('regDepartment').value),
            role: 'Clerk' // New users default to Clerk role
        };

        users.push(newUser);
        db.set('users', users);
        logActivity('User Registered', `New user created: ${newUser.fullName}`);
        document.getElementById('registrationModal').style.display = 'none';
        document.getElementById('registrationForm').reset();
        showTemporaryMessage('Account created successfully! You can now log in.');
    }

    function handleAssetFormSubmit(e) {
        e.preventDefault();
        const assetIdValue = document.getElementById('assetId').value;
        const isEditing = !!assetIdValue;
        const assetId = isEditing ? parseInt(assetIdValue) : getNextId('assets');

        const assets = db.get('assets');
        const assetData = {
            id: assetId,
            name: document.getElementById('assetName').value,
            tag: document.getElementById('assetTag').value,
            category: document.getElementById('assetCategory').value,
            locationId: document.getElementById('assetLocation').value,
            purchaseDate: document.getElementById('assetPurchaseDate').value,
            cost: parseFloat(document.getElementById('assetCost').value),
            currency: document.getElementById('assetCurrency').value,
            status: isEditing ? assets.find(a => a.id == assetId).status : 'Active',
        };

        if (isEditing) {
            const index = assets.findIndex(a => a.id == assetId);
            assets[index] = { ...assets[index], ...assetData };
            logActivity('Asset Updated', `Updated asset: ${assetData.name} (ID: ${assetId})`);
        } else {
            assetData.workOrderHistory = [];
            assetData.transferHistory = [];
            assets.push(assetData);
            logActivity('Asset Created', `Created asset: ${assetData.name}`);
        }
        db.set('assets', assets);

        const allParts = db.get('parts');
        const selectedPartIds = Array.from(document.getElementById('assetRelatedParts').selectedOptions).map(opt => parseInt(opt.value));
        
        allParts.forEach(part => {
            if (!part.relatedAssetIds) part.relatedAssetIds = [];
            
            const isSelected = selectedPartIds.includes(part.id);
            const isCurrentlyRelated = part.relatedAssetIds.includes(assetId);

            if (isSelected && !isCurrentlyRelated) {
                part.relatedAssetIds.push(assetId);
            } else if (!isSelected && isCurrentlyRelated) {
                part.relatedAssetIds = part.relatedAssetIds.filter(id => id !== assetId);
            }
        });
        db.set('parts', allParts);

        document.getElementById('assetModal').style.display = 'none';
        renderMainContent();
    }
    
    function deleteAsset(assetId) {
        if (confirm('Are you sure you want to delete this asset? This will also delete associated work orders.')) {
            let assets = db.get('assets');
            const assetToDelete = assets.find(a => a.id === assetId);
            assets = assets.filter(a => a.id !== assetId);
            db.set('assets', assets);

            let workOrders = db.get('workOrders');
            workOrders = workOrders.filter(wo => wo.assetId !== assetId);
            db.set('workOrders', workOrders);
            
            logActivity('Asset Deleted', `Deleted asset: ${assetToDelete.name} (ID: ${assetId})`);
            renderMainContent();
        }
    }
    
    function disposeAsset(assetId) {
        if (confirm('Are you sure you want to decommission this asset? Its status will be changed and it cannot be used for new work orders.')) {
            let assets = db.get('assets');
            const asset = assets.find(a => a.id === assetId);
            if (asset) {
                asset.status = 'Decommissioned';
                db.set('assets', assets);
                logActivity('Asset Decommissioned', `Decommissioned asset: ${asset.name} (ID: ${assetId})`);
                renderMainContent();
            }
        }
    }

    function handlePartFormSubmit(e) {
        e.preventDefault();
        const partId = document.getElementById('partId').value;
        const parts = db.get('parts');
        const relatedAssetIds = Array.from(document.getElementById('partRelatedAssets').selectedOptions).map(opt => parseInt(opt.value));
        const newQuantity = parseInt(document.getElementById('partQuantity').value);
        const originalQuantity = parseInt(document.getElementById('originalPartQuantity').value);

        const partData = {
            category: document.getElementById('partCategory').value,
            name: document.getElementById('partName').value,
            maker: document.getElementById('partMaker').value,
            sku: document.getElementById('partSku').value,
            quantity: newQuantity,
            minQuantity: parseInt(document.getElementById('partMinQuantity').value),
            supplier: document.getElementById('partSupplier').value,
            price: parseFloat(document.getElementById('partPrice').value) || 0,
            currency: document.getElementById('partCurrency').value,
            leadTime: document.getElementById('partLeadTime').value,
            locationId: document.getElementById('partLocation').value,
            attachmentRef: document.getElementById('partAttachmentRef').value,
            relatedAssetIds: relatedAssetIds
        };

        if (partId) {
            const index = parts.findIndex(p => p.id == partId);
            const part = parts[index];
            if (!part.transactionHistory) part.transactionHistory = [];
            
            const quantityChange = newQuantity - originalQuantity;
            if (quantityChange > 0) {
                part.transactionHistory.push({ date: new Date().toISOString(), type: 'In', quantity: quantityChange, details: 'Manual Stock Adjustment', user: state.currentUser.fullName });
            } else if (quantityChange < 0) {
                part.transactionHistory.push({ date: new Date().toISOString(), type: 'Out', quantity: Math.abs(quantityChange), details: 'Manual Stock Adjustment', user: state.currentUser.fullName });
            }

            parts[index] = { ...part, ...partData };
            logActivity('Spare Part Updated', `Updated part: ${partData.name}`);
        } else {
            partData.id = getNextId('parts');
            partData.transactionHistory = [{ date: new Date().toISOString(), type: 'In', quantity: newQuantity, details: 'Initial Stock', user: state.currentUser.fullName }];
            parts.push(partData);
            logActivity('Spare Part Created', `Created part: ${partData.name}`);
        }

        db.set('parts', parts);
        document.getElementById('partModal').style.display = 'none';
        renderMainContent();
    }
    
    function deletePart(partId) {
        if (confirm('Are you sure you want to delete this spare part?')) {
            let parts = db.get('parts');
            const partToDelete = parts.find(p => p.id === partId);
            parts = parts.filter(p => p.id !== partId);
            db.set('parts', parts);
            logActivity('Spare Part Deleted', `Deleted part: ${partToDelete.name}`);
            renderMainContent();
        }
    }
    
    function handlePartRequestFormSubmit(e) {
        e.preventDefault();
        const partRequests = db.get('partRequests');
        const isNewPart = document.getElementById('requestNewPartCheckbox').checked;
        
        const newRequest = {
            id: getNextId('partRequests'),
            quantity: parseInt(document.getElementById('requestQuantity').value),
            purpose: document.getElementById('requestPurpose').value,
            requesterId: state.currentUser.id,
            requestDate: new Date().toISOString(),
            status: 'Requested', // Status for new purchase requests
            notes: ''
        };

        if (isNewPart) {
            newRequest.partId = null;
            newRequest.newPartName = document.getElementById('newPartName').value;
            newRequest.newPartNumber = document.getElementById('newPartNumber').value;
            newRequest.newPartMaker = document.getElementById('newPartMaker').value;
            logActivity('New Part Request Submitted', `Requested ${newRequest.quantity} of new part: ${newRequest.newPartName}`);
        } else {
            newRequest.partId = parseInt(document.getElementById('requestPartId').value);
            const part = db.get('parts').find(p => p.id === newRequest.partId);
            if(part) {
                newRequest.newPartName = part.name;
                newRequest.newPartNumber = part.sku;
                newRequest.newPartMaker = part.maker;
            }
            logActivity('Part Request Submitted', `Requested ${newRequest.quantity} of part ID ${newRequest.partId}`);
        }

        partRequests.push(newRequest);
        db.set('partRequests', partRequests);
        
        document.getElementById('partRequestModal').style.display = 'none';
        renderMainContent();
    }

    function handleStorageRequestFormSubmit(e) {
        e.preventDefault();
        const partRequests = db.get('partRequests');
        const partId = parseInt(document.getElementById('storageRequestPartId').value);
        const part = db.get('parts').find(p => p.id === partId);

        const newRequest = {
            id: getNextId('partRequests'),
            partId: partId,
            quantity: parseInt(document.getElementById('storageRequestQuantity').value),
            purpose: document.getElementById('storageRequestPurpose').value,
            requesterId: state.currentUser.id,
            requestDate: new Date().toISOString(),
            status: 'Requested from Storage',
            notes: 'Internal Transfer',
            newPartName: part.name,
            newPartNumber: part.sku,
            newPartMaker: part.maker
        };
        partRequests.push(newRequest);
        db.set('partRequests', partRequests);
        logActivity('Storage Request Submitted', `Requested ${newRequest.quantity} of part ID ${newRequest.partId} from storage.`);
        document.getElementById('storageRequestModal').style.display = 'none';
        renderMainContent();
    }


    function handlePartRequestAction(requestId, newStatus) {
        const partRequests = db.get('partRequests');
        const request = partRequests.find(pr => pr.id === requestId);
        if (request) {
            request.approverId = state.currentUser.id;
            request.approvalDate = new Date().toISOString();
            
            if (newStatus === 'Approved') {
                if (request.status === 'Requested from Storage') {
                    const parts = db.get('parts');
                    const partIndex = parts.findIndex(p => p.id === request.partId);
                    if (partIndex !== -1) {
                        if (parts[partIndex].quantity >= request.quantity) {
                            parts[partIndex].quantity -= request.quantity;
                            if (!parts[partIndex].transactionHistory) parts[partIndex].transactionHistory = [];
                            parts[partIndex].transactionHistory.push({ date: new Date().toISOString(), type: 'Out', quantity: request.quantity, details: `Internal transfer for Request #${request.id}`, user: state.currentUser.fullName });
                            db.set('parts', parts);
                            request.status = 'Completed';
                            logActivity('Storage Request Approved', `Approved and transferred parts for request #${requestId}`);
                        } else {
                            showTemporaryMessage('Not enough stock to approve this storage request.', true);
                            return; // Stop further processing
                        }
                    }
                } else {
                    request.status = 'Approved';
                    logActivity('Part Request Approved', `Approved purchase request #${requestId}`);
                }
            } else {
                 request.status = 'Rejected';
                 logActivity('Part Request Rejected', `Rejected request #${requestId}`);
            }
            db.set('partRequests', partRequests);
            renderMainContent();
        }
    }

    function handleReceivePartsFormSubmit(e) {
        e.preventDefault();
        const requestId = parseInt(document.getElementById('receiveRequestId').value);
        const partRequests = db.get('partRequests');
        const request = partRequests.find(pr => pr.id === requestId);

        if (request) {
            request.status = 'Received';
            const receivedParts = db.get('receivedParts');
            const newReceivedPart = {
                id: getNextId('receivedParts'),
                partId: request.partId,
                quantity: request.quantity,
                requestId: request.id,
                receivedDate: new Date().toISOString(),
                receiverId: state.currentUser.id,
                newPartName: request.newPartName,
                newPartNumber: request.newPartNumber,
                newPartMaker: request.newPartMaker
            };
            
            receivedParts.push(newReceivedPart);
            db.set('partRequests', partRequests);
            db.set('receivedParts', receivedParts);
            logActivity('Parts Received', `Received parts for request #${request.id}`);
            document.getElementById('receivePartsModal').style.display = 'none';
            renderMainContent();
        }
    }

    function handleRestockPartsFormSubmit(e) {
        e.preventDefault();
        const receivedPartId = parseInt(document.getElementById('restockPartId').value);
        const newLocationId = document.getElementById('restockLocationId').value;
        
        let receivedParts = db.get('receivedParts');
        const receivedPart = receivedParts.find(rp => rp.id === receivedPartId);

        if (receivedPart) {
            const parts = db.get('parts');
            let part;

            if (receivedPart.partId) { // Existing part
                part = parts.find(p => p.id === receivedPart.partId);
            } else { // This is a new part, create it in the system
                part = {
                    id: getNextId('parts'),
                    name: receivedPart.newPartName,
                    sku: receivedPart.newPartNumber || 'N/A',
                    maker: receivedPart.newPartMaker || '',
                    quantity: 0, // Initial quantity is 0, will be updated next
                    minQuantity: 0, // Default, can be edited later
                    locationId: newLocationId,
                    category: 'Other', // Default category
                    transactionHistory: []
                };
                parts.push(part);
                logActivity('New Part Created from Request', `Part: ${part.name} (ID: ${part.id})`);
            }

            if (part) {
                part.quantity += receivedPart.quantity;
                 if (!part.transactionHistory) part.transactionHistory = [];
                part.transactionHistory.push({ date: new Date().toISOString(), type: 'In', quantity: receivedPart.quantity, details: `Restocked from Request #${receivedPart.requestId}`, user: state.currentUser.fullName });
                
                part.locationId = newLocationId;
                
                db.set('parts', parts);
                
                // Remove from received parts list
                receivedParts = receivedParts.filter(rp => rp.id !== receivedPartId);
                db.set('receivedParts', receivedParts);
                
                logActivity('Parts Restocked', `Restocked ${receivedPart.quantity} of part ${part.name}`);
                document.getElementById('restockPartsModal').style.display = 'none';
                renderMainContent();
            }
        }
    }


    function handleWorkOrderFormSubmit(e) {
        e.preventDefault();
        const woId = document.getElementById('workOrderId').value;
        const workOrders = db.get('workOrders');
        
        const requiredParts = [];
        const task = document.getElementById('woTask').value;
        if (task === 'Replacement' || task === 'Assemble') {
            document.querySelectorAll('.wo-part-row').forEach(row => {
                const partId = row.querySelector('.wo-part-select').value;
                const quantity = parseInt(row.querySelector('.wo-part-qty').value);
                if (partId && quantity > 0) {
                    requiredParts.push({ partId: parseInt(partId), quantity });
                }
            });
        }
        
        const checklist = [];
        document.querySelectorAll('#woChecklistContainer .checklist-item span').forEach(item => {
            checklist.push({ text: item.textContent, completed: false });
        });

        const newStatus = document.getElementById('woStatus').value;
        const woData = {
            title: document.getElementById('woTitle').value,
            description: document.getElementById('woDescription').value,
            assetId: parseInt(document.getElementById('woAsset').value),
            assignedTo: parseInt(document.getElementById('woAssignedTo').value),
            task: task,
            dueDate: document.getElementById('woDueDate').value,
            priority: document.getElementById('woPriority').value,
            frequency: document.getElementById('woFrequency').value,
            status: newStatus,
            breakdownTimestamp: document.getElementById('woBreakdownTime').value,
            requiredParts: requiredParts,
            checklist: checklist
        };
        
        if (woId) {
            const index = workOrders.findIndex(w => w.id == woId);
            const oldStatus = workOrders[index].status;
            workOrders[index] = { ...workOrders[index], ...woData };

            // Check if status changed to 'Completed'
            if (newStatus === 'Completed' && oldStatus !== 'Completed') {
                showCompleteWorkOrderModal(parseInt(woId));
            } else {
                logActivity('Work Order Updated', `Updated WO: ${woData.title}`);
            }

        } else {
            woData.id = getNextId('workOrders');
            if (woData.status === 'Completed') {
                woData.completedDate = new Date().toISOString();
                triggerCompletionTasks(woData);
            }
            workOrders.push(woData);
            logActivity('Work Order Created', `Created WO: ${woData.title}`);
        }
        
        db.set('workOrders', workOrders);
        document.getElementById('workOrderModal').style.display = 'none';
        render();
    }
    
    function deleteWorkOrder(woId) {
        if (confirm('Are you sure you want to delete this work order?')) {
            let workOrders = db.get('workOrders');
            const woToDelete = workOrders.find(w => w.id === woId);
            workOrders = workOrders.filter(w => w.id !== woId);
            db.set('workOrders', workOrders);
            logActivity('Work Order Deleted', `Deleted WO: ${woToDelete.title}`);
            render();
        }
    }
    
    function triggerCompletionTasks(completedWo) {
        // ... (part deduction logic remains the same)

        // Handle recurring work orders by creating the next one
        if (completedWo.frequency !== 'One-Time') {
            const [year, month, day] = completedWo.completedDate.split('T')[0].split('-').map(Number);
            const nextDueDate = new Date(Date.UTC(year, month - 1, day));

            switch(completedWo.frequency) {
                case 'Daily': nextDueDate.setUTCDate(nextDueDate.getUTCDate() + 1); break;
                case 'Weekly': nextDueDate.setUTCDate(nextDueDate.getUTCDate() + 7); break;
                case 'Monthly': nextDueDate.setUTCMonth(nextDueDate.getUTCMonth() + 1); break;
                case 'Yearly': nextDueDate.setUTCFullYear(nextDueDate.getUTCFullYear() + 1); break;
            }
            
            const newWo = JSON.parse(JSON.stringify(completedWo)); // Deep copy

            // Reset properties for the new recurring work order
            newWo.id = getNextId('workOrders');
            newWo.status = 'Open';
            newWo.dueDate = nextDueDate.toISOString().split('T')[0];
            delete newWo.completedDate;
            delete newWo.completionNotes;
            delete newWo.breakdownTimestamp;
            
            // Reset checklist items
            if (newWo.checklist) {
                newWo.checklist.forEach(item => item.completed = false);
            }
            
            const workOrders = db.get('workOrders');
            workOrders.push(newWo);
            db.set('workOrders', workOrders);
            logActivity('Recurring WO Generated', `New WO created for ${newWo.title}, due ${newWo.dueDate}`);

            // ... (auto-request parts logic remains the same)
        }
    }

    function handleCompleteWorkOrderFormSubmit(e) {
        e.preventDefault();
        const woId = parseInt(document.getElementById('completeWorkOrderId').value);
        const completionNotes = document.getElementById('completionNotes').value;
        const checklistItems = document.querySelectorAll('#completeWoChecklist input[type="checkbox"]');
        
        const allChecked = Array.from(checklistItems).every(checkbox => checkbox.checked);

        if (!allChecked && checklistItems.length > 0) {
            showTemporaryMessage('Please complete all checklist items before marking the work order as complete.', true);
            return;
        }

        let workOrders = db.get('workOrders');
        const woIndex = workOrders.findIndex(w => w.id === woId);

        if (woIndex !== -1) {
            const wo = workOrders[woIndex];
            if (wo.status === 'Completed') return; 

            wo.status = 'Completed';
            wo.completedDate = new Date().toISOString();
            wo.completionNotes = completionNotes;
            
            if(wo.checklist) {
                wo.checklist.forEach(item => item.completed = true);
            }
            
            // Save the completed work order FIRST.
            db.set('workOrders', workOrders);
            logActivity('Work Order Completed', `Completed WO #${wo.id}: ${wo.title}`);
            
            // Now handle recurring tasks and part deductions
            triggerCompletionTasks(wo);
            
            document.getElementById('completeWorkOrderModal').style.display = 'none';
            render(); // Re-render the UI
        }
    }

    function handleAddDivision(e) {
        e.preventDefault();
        const locations = db.get('locations');
        const name = document.getElementById('newDivisionName').value;
        if (!locations.divisions) locations.divisions = [];
        locations.divisions.push({ id: getNextIdForLocation('divisions'), name });
        db.set('locations', locations);
        logActivity('Location Added', `Added Division: ${name}`);
        renderMainContent();
    }
    function handleAddDepartment(e) {
        e.preventDefault();
        const locations = db.get('locations');
        const name = document.getElementById('newDepartmentName').value;
        const divisionId = parseInt(document.getElementById('departmentDivisionSelect').value);
        if (!locations.departments) locations.departments = [];
        locations.departments.push({ id: getNextIdForLocation('departments'), name, divisionId });
        db.set('locations', locations);
        logActivity('Location Added', `Added Department: ${name}`);
        renderMainContent();
    }
    function handleAddProductionLine(e) {
        e.preventDefault();
        const locations = db.get('locations');
        const name = document.getElementById('newProductionLineName').value;
        const departmentId = parseInt(document.getElementById('productionLineDepartmentSelect').value);
        if (!locations.productionLines) locations.productionLines = [];
        locations.productionLines.push({ id: getNextIdForLocation('productionLines'), name, departmentId });
        db.set('locations', locations);
        logActivity('Location Added', `Added Production Line: ${name}`);
        renderMainContent();
    }
    function handleAddCabinet(e) {
        e.preventDefault();
        const locations = db.get('locations');
        const name = document.getElementById('newCabinetName').value;
        const departmentId = parseInt(document.getElementById('cabinetDepartmentSelect').value);
        if (!locations.cabinets) locations.cabinets = [];
        locations.cabinets.push({ id: getNextIdForLocation('cabinets'), name, departmentId });
        db.set('locations', locations);
        logActivity('Location Added', `Added Cabinet: ${name}`);
        renderMainContent();
    }
    function handleAddShelf(e) {
        e.preventDefault();
        const locations = db.get('locations');
        const name = document.getElementById('newShelfName').value;
        const cabinetId = parseInt(document.getElementById('shelfCabinetSelect').value);
        if (!locations.shelves) locations.shelves = [];
        locations.shelves.push({ id: getNextIdForLocation('shelves'), name, cabinetId });
        db.set('locations', locations);
        logActivity('Location Added', `Added Shelf: ${name}`);
        renderMainContent();
    }
    function handleAddBox(e) {
        e.preventDefault();
        const locations = db.get('locations');
        const name = document.getElementById('newBoxName').value;
        const shelfId = parseInt(document.getElementById('boxShelfSelect').value);
        if (!locations.boxes) locations.boxes = [];
        locations.boxes.push({ id: getNextIdForLocation('boxes'), name, shelfId });
        db.set('locations', locations);
        logActivity('Location Added', `Added Box: ${name}`);
        renderMainContent();
    }
    
    function handleDeleteLocation(type, id) {
        if (confirm(`Are you sure you want to delete this location? This may affect items assigned to it.`)) {
            const locations = db.get('locations');
            let name = '';
            const locationMap = {
                division: 'divisions',
                department: 'departments',
                productionLine: 'productionLines',
                cabinet: 'cabinets',
                shelf: 'shelves',
                box: 'boxes'
            };
            const key = locationMap[type];
            if(key && locations[key]) {
                const item = locations[key].find(l => l.id === id);
                name = item ? item.name : '';
                locations[key] = locations[key].filter(l => l.id !== id);
            }
            
            db.set('locations', locations);
            logActivity('Location Deleted', `Deleted ${type}: ${name}`);
            renderMainContent();
        }
    }
    
    function handleTableSort(e, type, tableBodyId, data) {
        const header = e.target.closest('th');
        if (!header || !header.dataset.sort) return;

        const key = header.dataset.sort;
        if (state.sortKey === key) {
            state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            state.sortKey = key;
            state.sortOrder = 'asc';
        }

        document.getElementById(tableBodyId).innerHTML = generateTableRows(type, data);
    }
    
    function handlePrintAssets() {
        const assets = db.get('assets').filter(can.view);
        const { departments = [], productionLines = [] } = db.get('locations') || {};
        let groupedByDept = {};
        
        assets.forEach(asset => {
            const [locType, locId] = asset.locationId.split('-');
            const pLine = productionLines.find(l => l.id === parseInt(locId));
            if (!pLine) return;
            const dept = departments.find(d => d.id === pLine.departmentId);
            if (!dept) return;

            if (!groupedByDept[dept.name]) {
                groupedByDept[dept.name] = [];
            }
            groupedByDept[dept.name].push(asset);
        });

        let printHtml = `
            <div style="font-family: Arial, sans-serif; padding: 20px;">
                <h1 style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px;">Asset List Report</h1>
                <p style="text-align: right; margin-bottom: 20px;">Printed on: ${new Date().toLocaleDateString()}</p>
        `;

        for (const deptName in groupedByDept) {
            printHtml += `
                <h2 style="background-color: #f2f2f2; padding: 10px; margin-top: 20px; border-bottom: 1px solid #ddd;">Department: ${deptName}</h2>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background-color: #e0e0e0;">
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Asset Name</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Tag</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Location</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            groupedByDept[deptName].forEach(asset => {
                printHtml += `
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 8px;">${asset.name}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${asset.tag}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${getFullLocationName(asset.locationId)}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${asset.status}</td>
                    </tr>
                `;
            });
            printHtml += `</tbody></table>`;
        }

        printHtml += `</div>`;
        
        const printArea = document.getElementById('print-area');
        printArea.innerHTML = printHtml;
        window.print();
    }

    function handlePrintParts() {
        const parts = db.get('parts').filter(can.view);
        const { departments = [], cabinets = [], shelves = [], boxes = [] } = db.get('locations') || {};
        let groupedByDept = {};

        parts.forEach(part => {
            if (typeof part.locationId !== 'string' || !part.locationId.includes('-')) return;
            const [locType, locId] = part.locationId.split('-');
            let deptId;

            if(locType === 'box') {
                const box = boxes.find(b => b.id === parseInt(locId));
                if (!box) return;
                const shelf = shelves.find(s => s.id === box.shelfId);
                if (!shelf) return;
                const cabinet = cabinets.find(c => c.id === shelf.cabinetId);
                if(cabinet) deptId = cabinet.departmentId;
            } else if (locType === 'sh') {
                const shelf = shelves.find(s => s.id === parseInt(locId));
                if (!shelf) return;
                const cabinet = cabinets.find(c => c.id === shelf.cabinetId);
                if(cabinet) deptId = cabinet.departmentId;
            } else if (locType === 'cab') {
                const cabinet = cabinets.find(c => c.id === parseInt(locId));
                if(cabinet) deptId = cabinet.departmentId;
            }
            
            if (!deptId) return;
            const dept = departments.find(d => d.id === deptId);
            if (!dept) return;

            if (!groupedByDept[dept.name]) {
                groupedByDept[dept.name] = [];
            }
            groupedByDept[dept.name].push(part);
        });

        let printHtml = `
            <div style="font-family: Arial, sans-serif; padding: 20px;">
                <h1 style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px;">Spare Parts List Report</h1>
                <p style="text-align: right; margin-bottom: 20px;">Printed on: ${new Date().toLocaleDateString()}</p>
        `;

        for (const deptName in groupedByDept) {
            printHtml += `
                <h2 style="background-color: #f2f2f2; padding: 10px; margin-top: 20px; border-bottom: 1px solid #ddd;">Department: ${deptName}</h2>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background-color: #e0e0e0;">
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Part Name</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">SKU</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Quantity</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Location</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            groupedByDept[deptName].forEach(part => {
                printHtml += `
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 8px;">${part.name}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${part.sku}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${part.quantity}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${getFullLocationName(part.locationId)}</td>
                    </tr>
                `;
            });
            printHtml += `</tbody></table>`;
        }

        printHtml += `</div>`;
        
        const printArea = document.getElementById('print-area');
        printArea.innerHTML = printHtml;
        window.print();
    }

    function handlePrintWorkOrders() {
        const workOrders = db.get('workOrders').filter(can.view);
        const assets = db.get('assets');
        const { departments = [], productionLines = [] } = db.get('locations') || {};
        let groupedByDept = {};

        workOrders.forEach(wo => {
            const asset = assets.find(a => a.id === wo.assetId);
            if (!asset) return;
            const [locType, locId] = asset.locationId.split('-');
            const pLine = productionLines.find(l => l.id === parseInt(locId));
            if (!pLine) return;
            const dept = departments.find(d => d.id === pLine.departmentId);
            if (!dept) return;

            if (!groupedByDept[dept.name]) {
                groupedByDept[dept.name] = [];
            }
            groupedByDept[dept.name].push(wo);
        });

        let printHtml = `
            <div style="font-family: Arial, sans-serif; padding: 20px;">
                <h1 style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px;">Work Order List Report</h1>
                <p style="text-align: right; margin-bottom: 20px;">Printed on: ${new Date().toLocaleDateString()}</p>
        `;

        for (const deptName in groupedByDept) {
            printHtml += `
                <h2 style="background-color: #f2f2f2; padding: 10px; margin-top: 20px; border-bottom: 1px solid #ddd;">Department: ${deptName}</h2>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background-color: #e0e0e0;">
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Title</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Asset</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Due Date</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Priority</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            groupedByDept[deptName].forEach(wo => {
                const assetName = assets.find(a => a.id === wo.assetId)?.name || 'N/A';
                printHtml += `
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 8px;">${wo.title}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${assetName}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${wo.dueDate}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${wo.priority}</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">${wo.status}</td>
                    </tr>
                `;
            });
            printHtml += `</tbody></table>`;
        }

        printHtml += `</div>`;
        
        const printArea = document.getElementById('print-area');
        printArea.innerHTML = printHtml;
        window.print();
    }

    function handlePrintPurchaseList() {
        const requestsToPurchase = db.get('partRequests').filter(req => req.status === 'Approved');
        
        if (requestsToPurchase.length === 0) {
            showTemporaryMessage('No approved purchase requests to print.', true);
            return;
        }

        const users = db.get('users');

        let printHtml = `
            <div style="font-family: Arial, sans-serif; padding: 20px;">
                <h1 style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px;">Purchase Request List</h1>
                <p style="text-align: right; margin-bottom: 20px;">Printed on: ${new Date().toLocaleDateString()}</p>
                <p style="margin-bottom: 20px;">Requested by: ${state.currentUser.fullName}</p>
                
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background-color: #e0e0e0;">
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Part Name</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Part Number/SKU</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Maker</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">Quantity</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Purpose</th>
                            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Requested By</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        requestsToPurchase.forEach(req => {
            const requester = users.find(u => u.id === req.requesterId);
            printHtml += `
                <tr>
                    <td style="border: 1px solid #ccc; padding: 8px;">${req.newPartName}</td>
                    <td style="border: 1px solid #ccc; padding: 8px;">${req.newPartNumber || 'N/A'}</td>
                    <td style="border: 1px solid #ccc; padding: 8px;">${req.newPartMaker || 'N/A'}</td>
                    <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${req.quantity}</td>
                    <td style="border: 1px solid #ccc; padding: 8px;">${req.purpose}</td>
                    <td style="border: 1px solid #ccc; padding: 8px;">${requester ? requester.fullName : 'N/A'}</td>
                </tr>
            `;
        });

        printHtml += `
                </tbody>
            </table>
            <div style="margin-top: 40px; display: flex; justify-content: space-between;">
                <div>
                    <p>_________________________</p>
                    <p>Prepared By</p>
                </div>
                <div>
                    <p>_________________________</p>
                    <p>Approved By</p>
                </div>
            </div>
        </div>`;
        
        const printArea = document.getElementById('print-area');
        printArea.innerHTML = printHtml;
        window.print();
    }
    
    function handleAssetImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n').slice(1); // Skip header
            const assets = db.get('assets');
            lines.forEach(line => {
                const [name, tag, category, locationId, purchaseDate, cost, currency] = line.split(',');
                if (name && tag && locationId) {
                    assets.push({
                        id: getNextId('assets'),
                        name: name.trim(),
                        tag: tag.trim(),
                        category: category.trim(),
                        locationId: locationId.trim(),
                        purchaseDate: purchaseDate.trim(),
                        cost: parseFloat(cost),
                        currency: currency.trim(),
                        status: 'Active',
                        workOrderHistory: [],
                        transferHistory: []
                    });
                }
            });
            db.set('assets', assets);
            logActivity('Assets Imported', `Imported ${lines.length} assets from CSV.`);
            renderMainContent();
        };
        reader.readAsText(file);
    }
    
    function handlePartImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n').slice(1);
            const parts = db.get('parts');
            lines.forEach(line => {
                const [name, sku, category, quantity, minQuantity, locationId] = line.split(',');
                if (name && sku && locationId) {
                    const newPart = {
                        id: getNextId('parts'),
                        name: name.trim(),
                        sku: sku.trim(),
                        category: category.trim(),
                        quantity: parseInt(quantity),
                        minQuantity: parseInt(minQuantity),
                        locationId: locationId.trim(),
                        transactionHistory: [{ date: new Date().toISOString(), type: 'In', quantity: parseInt(quantity), details: 'Initial Stock from CSV import', user: state.currentUser.fullName }]
                    };
                    parts.push(newPart);
                }
            });
            db.set('parts', parts);
            logActivity('Parts Imported', `Imported ${lines.length} parts from CSV.`);
            renderMainContent();
        };
        reader.readAsText(file);
    }
    
    // =================================================================================
    //  PARTITION 7: INITIALIZATION & EVENT LISTENERS
    // =================================================================================
    
    function attachGlobalEventListeners() {
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('bypassLoginBtn').addEventListener('click', handleBypassLogin);
        document.getElementById('createAccountBtn').addEventListener('click', () => {
            populateLocationDropdowns(document.getElementById('regDivision'), document.getElementById('regDepartment'));
            document.getElementById('registrationModal').style.display = 'flex';
        });
        document.getElementById('registrationForm').addEventListener('submit', handleRegistration);
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);

        document.getElementById('sidebar').addEventListener('click', (e) => {
            const navLink = e.target.closest('.nav-link');
            if (navLink) {
                e.preventDefault();
                state.currentPage = navLink.dataset.page;
                render();
            }
        });

        // Master event listener for modal buttons and other dynamic elements
        document.body.addEventListener('click', (e) => {
            // Modal close button
            if (e.target.closest('[data-close-modal]')) {
                const modal = e.target.closest('.modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            // Checklist Item Add Button
            if (e.target.id === 'addChecklistItemBtn') {
                const input = document.getElementById('newChecklistItem');
                if (input.value.trim()) {
                    addChecklistItem(input.value.trim());
                    input.value = '';
                }
            }
            // Checklist Item Remove Button
            if (e.target.closest('.remove-checklist-item-btn')) {
                e.target.closest('.checklist-item').remove();
            }
        });
        
        // Centralized event listener for main content area
        document.getElementById('mainContent').addEventListener('click', (e) => {
            handleMainContentClicks(e);
        });
    }

    function handleMainContentClicks(e) {
        const target = e.target;
        const button = target.closest('button');
        if (button) {
            const id = parseInt(button.dataset.id);

            // Asset actions
            if (button.classList.contains('view-asset-btn')) showAssetDetailModal(id);
            if (button.classList.contains('edit-asset-btn')) showAssetModal(id);
            if (button.classList.contains('transfer-asset-btn')) showTransferAssetModal(id);
            if (button.classList.contains('delete-asset-btn')) deleteAsset(id);
            if (button.classList.contains('dispose-asset-btn')) disposeAsset(id);

            // Part actions
            if (button.classList.contains('view-part-btn')) showPartDetailModal(id);
            if (button.classList.contains('edit-part-btn')) showPartModal(id);
            if (button.classList.contains('delete-part-btn')) deletePart(id);
            
            // Part Request actions
            if (button.classList.contains('approve-pr-btn')) handlePartRequestAction(id, 'Approved');
            if (button.classList.contains('reject-pr-btn')) handlePartRequestAction(id, 'Rejected');

            // Work Order actions
            if (button.classList.contains('view-wo-btn')) showWorkOrderDetailModal(id);
            if (button.classList.contains('edit-wo-btn')) showWorkOrderModal(id);
            if (button.classList.contains('complete-wo-btn')) showCompleteWorkOrderModal(id);
            if (button.classList.contains('delete-wo-btn')) deleteWorkOrder(id);
        }
    }

    function attachAssetPageEventListeners() {
        document.getElementById('addAssetBtn').addEventListener('click', () => showAssetModal());
        document.getElementById('importAssetsBtn').addEventListener('click', () => document.getElementById('csvAssetInput').click());
        document.getElementById('csvAssetInput').addEventListener('change', handleAssetImport);
        document.getElementById('assetForm').addEventListener('submit', handleAssetFormSubmit);
        document.getElementById('assetSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const allAssets = db.get('assets').filter(can.view);
            const filtered = allAssets.filter(a => 
                a.name.toLowerCase().includes(searchTerm) ||
                a.tag.toLowerCase().includes(searchTerm) ||
                a.category.toLowerCase().includes(searchTerm)
            );
            document.getElementById('assetTableBody').innerHTML = generateTableRows('assets', filtered);
        });
        document.getElementById('printAssetsBtn').addEventListener('click', handlePrintAssets);
    }
    
    function attachPartsPageEventListeners() {
        document.getElementById('addPartBtn').addEventListener('click', () => showPartModal());
        document.getElementById('printPartsBtn').addEventListener('click', handlePrintParts);
        document.getElementById('importPartsBtn').addEventListener('click', () => document.getElementById('csvFileInput').click());
        document.getElementById('csvFileInput').addEventListener('change', handlePartImport);
        document.getElementById('partForm').addEventListener('submit', handlePartFormSubmit);
        document.getElementById('partSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const allParts = db.get('parts').filter(can.view);
            const filtered = allParts.filter(p => 
                p.name.toLowerCase().includes(searchTerm) ||
                p.sku.toLowerCase().includes(searchTerm) ||
                (p.category && p.category.toLowerCase().includes(searchTerm)) ||
                (p.maker && p.maker.toLowerCase().includes(searchTerm))
            );
            document.getElementById('partTableBody').innerHTML = generateTableRows('parts', filtered);
        });
    }

    function attachPartsRequestPageEventListeners() {
        document.getElementById('newPartRequestBtn').addEventListener('click', showPartRequestModal);
        document.getElementById('requestFromStorageBtn').addEventListener('click', showStorageRequestModal);
        document.getElementById('receivePartsBtn').addEventListener('click', showReceivePartsModal);
        document.getElementById('restockPartsBtn').addEventListener('click', showRestockPartsModal);
        document.getElementById('printPurchaseListBtn').addEventListener('click', handlePrintPurchaseList);
        document.getElementById('partRequestForm').addEventListener('submit', handlePartRequestFormSubmit);
        document.getElementById('storageRequestForm').addEventListener('submit', handleStorageRequestFormSubmit);
        document.getElementById('receivePartsForm').addEventListener('submit', handleReceivePartsFormSubmit);
        document.getElementById('restockPartsForm').addEventListener('submit', handleRestockPartsFormSubmit);
    }
    
    function attachWorkOrdersPageEventListeners() {
        document.getElementById('addWorkOrderBtn').addEventListener('click', () => showWorkOrderModal());
        document.getElementById('addUrgentWorkOrderBtn').addEventListener('click', () => showWorkOrderModal(null, true));
        document.getElementById('printWorkOrdersBtn').addEventListener('click', handlePrintWorkOrders);
        document.getElementById('workOrderForm').addEventListener('submit', handleWorkOrderFormSubmit);
        document.getElementById('completeWorkOrderForm').addEventListener('submit', handleCompleteWorkOrderFormSubmit);
        document.getElementById('workOrderSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const allWos = db.get('workOrders').filter(can.view);
            const assets = db.get('assets');
            const filtered = allWos.filter(wo => {
                const assetName = assets.find(a => a.id === wo.assetId)?.name || '';
                return wo.title.toLowerCase().includes(searchTerm) || assetName.toLowerCase().includes(searchTerm)
            });
            document.getElementById('workOrderTableBody').innerHTML = generateTableRows('workOrders', filtered);
        });
    }
    
    function attachCalendarEventListeners() {
        document.getElementById('prevMonthBtn').addEventListener('click', () => {
            state.calendarDate.setMonth(state.calendarDate.getMonth() - 1);
            renderMainContent();
        });
        document.getElementById('nextMonthBtn').addEventListener('click', () => {
            state.calendarDate.setMonth(state.calendarDate.getMonth() + 1);
            renderMainContent();
        });
        document.querySelector('#mainContent').addEventListener('click', (e) => {
            const dayEl = e.target.closest('.calendar-day');
            if (dayEl && dayEl.dataset.date) {
                const date = dayEl.dataset.date;
                const workOrders = db.get('workOrders').filter(wo => wo.dueDate === date);
                showCalendarDetailModal(date, workOrders);
            }
        });
    }
    
    function attachLocationsPageEventListeners() {
        const isAdmin = state.currentUser.role === 'Admin';

        if (isAdmin) {
            document.getElementById('addDivisionForm').addEventListener('submit', handleAddDivision);
            document.getElementById('addDepartmentForm').addEventListener('submit', handleAddDepartment);
            document.getElementById('addProductionLineForm').addEventListener('submit', handleAddProductionLine);
            
            document.getElementById('divisionList').addEventListener('click', e => {
                const btn = e.target.closest('.delete-division-btn');
                if(btn) handleDeleteLocation('division', parseInt(btn.dataset.id));
            });
            document.getElementById('departmentList').addEventListener('click', e => {
                const btn = e.target.closest('.delete-department-btn');
                if(btn) handleDeleteLocation('department', parseInt(btn.dataset.id));
            });
            document.getElementById('productionLineList').addEventListener('click', e => {
                const btn = e.target.closest('.delete-pline-btn');
                if(btn) handleDeleteLocation('productionLine', parseInt(btn.dataset.id));
            });
        }

        // These are for storage locations, which everyone can access
        document.getElementById('addCabinetForm').addEventListener('submit', handleAddCabinet);
        document.getElementById('addShelfForm').addEventListener('submit', handleAddShelf);
        document.getElementById('addBoxForm').addEventListener('submit', handleAddBox);
        
        document.getElementById('cabinetList').addEventListener('click', e => {
            const btn = e.target.closest('.delete-cabinet-btn');
            if(btn) handleDeleteLocation('cabinet', parseInt(btn.dataset.id));
        });
        document.getElementById('shelfList').addEventListener('click', e => {
            const btn = e.target.closest('.delete-shelf-btn');
            if(btn) handleDeleteLocation('shelf', parseInt(btn.dataset.id));
        });
        document.getElementById('boxList').addEventListener('click', e => {
            const btn = e.target.closest('.delete-box-btn');
            if(btn) handleDeleteLocation('box', parseInt(btn.dataset.id));
        });
    }
    
    function attachUserManagementEventListeners() {
        document.getElementById('userTable').addEventListener('click', e => {
            const btn = e.target.closest('.delete-user-btn');
            if (btn) {
                const userId = parseInt(btn.dataset.id);
                if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                    let users = db.get('users');
                    const userToDelete = users.find(u => u.id === userId);
                    users = users.filter(u => u.id !== userId);
                    db.set('users', users);
                    logActivity('User Deleted', `Deleted user: ${userToDelete.fullName} (${userToDelete.username})`);
                    render();
                }
            }
        });
    }

    // --- APPLICATION INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        db.init();
        attachGlobalEventListeners();
        render();
    });

})();
</script>

</body>
</html>
